/**
 * tle-parser v1.0.0
 * A parser for TLE (Two-Line Element) satellite data.
 * @license MIT
 */
import{mkdir as e,writeFile as t,readFile as i}from"fs/promises";import{readFile as s,createReadStream as n,existsSync as r}from"fs";import{join as a}from"path";import{homedir as o}from"os";import{promisify as c}from"util";import{Transform as l}from"stream";import{createGunzip as u}from"zlib";var h;function m(e){return Object.values(h).includes(e)}function d(e){return{[h.INVALID_INPUT_TYPE]:"Input data must be a string",[h.EMPTY_INPUT]:"Input string is empty or contains only whitespace",[h.INVALID_LINE_COUNT]:"TLE must contain exactly 2 or 3 lines",[h.INVALID_LINE_LENGTH]:"TLE line must be exactly 69 characters",[h.INVALID_LINE_NUMBER]:"Line number must be 1 or 2",[h.CHECKSUM_MISMATCH]:"Calculated checksum does not match",[h.INVALID_CHECKSUM_CHARACTER]:"Checksum must be a digit 0-9",[h.SATELLITE_NUMBER_MISMATCH]:"Satellite numbers on line 1 and line 2 must match",[h.INVALID_SATELLITE_NUMBER]:"Satellite catalog number is invalid",[h.INVALID_CLASSIFICATION]:"Classification must be U, C, or S",[h.VALUE_OUT_OF_RANGE]:"Field value is outside valid range",[h.INVALID_NUMBER_FORMAT]:"Field contains invalid numeric format",[h.SATELLITE_NAME_TOO_LONG]:"Satellite name exceeds maximum length",[h.SATELLITE_NAME_FORMAT_WARNING]:"Satellite name contains unusual characters",[h.CLASSIFIED_DATA_WARNING]:"TLE contains classified satellite data",[h.STALE_TLE_WARNING]:"TLE epoch is significantly old",[h.HIGH_ECCENTRICITY_WARNING]:"Eccentricity is unusually high",[h.LOW_MEAN_MOTION_WARNING]:"Mean motion is unusually low",[h.DEPRECATED_EPOCH_YEAR_WARNING]:"Epoch year is in the far past",[h.REVOLUTION_NUMBER_ROLLOVER_WARNING]:"Revolution number may have rolled over",[h.NEAR_ZERO_DRAG_WARNING]:"Drag coefficient is near zero",[h.NON_STANDARD_EPHEMERIS_WARNING]:"Ephemeris type is non-standard",[h.NEGATIVE_DECAY_WARNING]:"Mean motion decay is negative"}[e]||"Unknown error code"}function p(e){return[h.SATELLITE_NAME_FORMAT_WARNING,h.CLASSIFIED_DATA_WARNING,h.STALE_TLE_WARNING,h.HIGH_ECCENTRICITY_WARNING,h.LOW_MEAN_MOTION_WARNING,h.DEPRECATED_EPOCH_YEAR_WARNING,h.REVOLUTION_NUMBER_ROLLOVER_WARNING,h.NEAR_ZERO_DRAG_WARNING,h.NON_STANDARD_EPHEMERIS_WARNING,h.NEGATIVE_DECAY_WARNING].includes(e)}function g(e){return!p(e)}!function(e){e.INVALID_INPUT_TYPE="INVALID_INPUT_TYPE",e.EMPTY_INPUT="EMPTY_INPUT",e.INVALID_LINE_COUNT="INVALID_LINE_COUNT",e.INVALID_LINE_LENGTH="INVALID_LINE_LENGTH",e.INVALID_LINE_NUMBER="INVALID_LINE_NUMBER",e.CHECKSUM_MISMATCH="CHECKSUM_MISMATCH",e.INVALID_CHECKSUM_CHARACTER="INVALID_CHECKSUM_CHARACTER",e.SATELLITE_NUMBER_MISMATCH="SATELLITE_NUMBER_MISMATCH",e.INVALID_SATELLITE_NUMBER="INVALID_SATELLITE_NUMBER",e.INVALID_CLASSIFICATION="INVALID_CLASSIFICATION",e.VALUE_OUT_OF_RANGE="VALUE_OUT_OF_RANGE",e.INVALID_NUMBER_FORMAT="INVALID_NUMBER_FORMAT",e.SATELLITE_NAME_TOO_LONG="SATELLITE_NAME_TOO_LONG",e.SATELLITE_NAME_FORMAT_WARNING="SATELLITE_NAME_FORMAT_WARNING",e.CLASSIFIED_DATA_WARNING="CLASSIFIED_DATA_WARNING",e.STALE_TLE_WARNING="STALE_TLE_WARNING",e.HIGH_ECCENTRICITY_WARNING="HIGH_ECCENTRICITY_WARNING",e.LOW_MEAN_MOTION_WARNING="LOW_MEAN_MOTION_WARNING",e.DEPRECATED_EPOCH_YEAR_WARNING="DEPRECATED_EPOCH_YEAR_WARNING",e.REVOLUTION_NUMBER_ROLLOVER_WARNING="REVOLUTION_NUMBER_ROLLOVER_WARNING",e.NEAR_ZERO_DRAG_WARNING="NEAR_ZERO_DRAG_WARNING",e.NON_STANDARD_EPHEMERIS_WARNING="NON_STANDARD_EPHEMERIS_WARNING",e.NEGATIVE_DECAY_WARNING="NEGATIVE_DECAY_WARNING"}(h||(h={})),h.INVALID_INPUT_TYPE,h.EMPTY_INPUT,h.INVALID_LINE_COUNT,h.INVALID_LINE_LENGTH,h.INVALID_LINE_NUMBER,h.CHECKSUM_MISMATCH,h.INVALID_CHECKSUM_CHARACTER,h.SATELLITE_NUMBER_MISMATCH,h.INVALID_SATELLITE_NUMBER,h.INVALID_CLASSIFICATION,h.VALUE_OUT_OF_RANGE,h.INVALID_NUMBER_FORMAT,h.SATELLITE_NAME_TOO_LONG,h.SATELLITE_NAME_FORMAT_WARNING,h.CLASSIFIED_DATA_WARNING,h.STALE_TLE_WARNING,h.HIGH_ECCENTRICITY_WARNING,h.LOW_MEAN_MOTION_WARNING,h.DEPRECATED_EPOCH_YEAR_WARNING,h.REVOLUTION_NUMBER_ROLLOVER_WARNING,h.NEAR_ZERO_DRAG_WARNING,h.NON_STANDARD_EPHEMERIS_WARNING,h.NEGATIVE_DECAY_WARNING;var N,f,E,I,A,T;function R(e){return!0===e.success}function L(e){return!1===e.success}function _(e){return!0===e.success}function y(e){return!1===e.success}function S(e){return"object"==typeof e&&null!==e&&"code"in e&&"message"in e&&"severity"in e}function v(e){return S(e)&&"warning"===e.severity}function C(e){return"U"===e||"C"===e||"S"===e}function D(e){return"object"==typeof e&&null!==e&&["lineNumber1","satelliteNumber1","classification","lineNumber2","satelliteNumber2","inclination","rightAscension","eccentricity","argumentOfPerigee","meanAnomaly","meanMotion"].every(t=>t in e)}!function(e){e.INVALID_LINE_COUNT="INVALID_LINE_COUNT",e.INVALID_LINE_LENGTH="INVALID_LINE_LENGTH",e.INVALID_LINE_NUMBER="INVALID_LINE_NUMBER",e.SATELLITE_NUMBER_MISMATCH="SATELLITE_NUMBER_MISMATCH",e.CHECKSUM_MISMATCH="CHECKSUM_MISMATCH",e.INVALID_CHECKSUM_CHARACTER="INVALID_CHECKSUM_CHARACTER",e.INVALID_CLASSIFICATION="INVALID_CLASSIFICATION",e.INVALID_SATELLITE_NUMBER="INVALID_SATELLITE_NUMBER",e.INVALID_INTL_DESIGNATOR_YEAR="INVALID_INTL_DESIGNATOR_YEAR",e.INVALID_INTL_DESIGNATOR_LAUNCH="INVALID_INTL_DESIGNATOR_LAUNCH",e.INVALID_EPOCH_YEAR="INVALID_EPOCH_YEAR",e.INVALID_EPOCH_DAY="INVALID_EPOCH_DAY",e.INVALID_EPHEMERIS_TYPE="INVALID_EPHEMERIS_TYPE",e.INVALID_ELEMENT_SET_NUMBER="INVALID_ELEMENT_SET_NUMBER",e.INVALID_INCLINATION="INVALID_INCLINATION",e.INVALID_RIGHT_ASCENSION="INVALID_RIGHT_ASCENSION",e.INVALID_ECCENTRICITY="INVALID_ECCENTRICITY",e.INVALID_ARG_OF_PERIGEE="INVALID_ARG_OF_PERIGEE",e.INVALID_MEAN_ANOMALY="INVALID_MEAN_ANOMALY",e.INVALID_MEAN_MOTION="INVALID_MEAN_MOTION",e.INVALID_REVOLUTION_NUMBER="INVALID_REVOLUTION_NUMBER",e.UNUSUAL_CLASSIFICATION="UNUSUAL_CLASSIFICATION",e.OLD_EPOCH="OLD_EPOCH",e.EXTREME_ECCENTRICITY="EXTREME_ECCENTRICITY",e.EXTREME_INCLINATION="EXTREME_INCLINATION",e.HIGH_MEAN_MOTION="HIGH_MEAN_MOTION",e.LOW_MEAN_MOTION="LOW_MEAN_MOTION",e.PARSE_ERROR="PARSE_ERROR",e.VALIDATION_ERROR="VALIDATION_ERROR"}(N||(N={})),function(e){e.INITIAL="INITIAL",e.READING_NAME="READING_NAME",e.READING_LINE1="READING_LINE1",e.READING_LINE2="READING_LINE2",e.COMPLETE="COMPLETE",e.ERROR="ERROR",e.RECOVERING="RECOVERING"}(f||(f={})),function(e){e.CONTINUE="CONTINUE",e.SKIP_FIELD="SKIP_FIELD",e.USE_DEFAULT="USE_DEFAULT",e.ATTEMPT_FIX="ATTEMPT_FIX",e.ABORT="ABORT"}(E||(E={})),function(e){e.INITIAL="INITIAL",e.DETECTING_FORMAT="DETECTING_FORMAT",e.PARSING_NAME="PARSING_NAME",e.PARSING_LINE1="PARSING_LINE1",e.PARSING_LINE2="PARSING_LINE2",e.VALIDATING="VALIDATING",e.COMPLETED="COMPLETED",e.ERROR="ERROR"}(I||(I={})),function(e){e.WARNING="warning",e.ERROR="error",e.CRITICAL="critical"}(A||(A={})),function(e){e.CONTINUE="CONTINUE",e.SKIP_FIELD="SKIP_FIELD",e.USE_DEFAULT="USE_DEFAULT",e.ATTEMPT_FIX="ATTEMPT_FIX",e.ABORT="ABORT"}(T||(T={}));class b{constructor(e={}){this.options={attemptRecovery:!0,maxRecoveryAttempts:10,includePartialResults:!0,strictMode:!1,...e},this.state=I.INITIAL,this.errors=[],this.warnings=[],this.recoveryActions=[],this.parsedData={},this.context={lineCount:0,hasName:!1,nameLineIndex:-1,line1Index:-1,line2Index:-1,lines:[],recoveryAttempts:0},this.reset()}reset(){this.state=I.INITIAL,this.errors=[],this.warnings=[],this.recoveryActions=[],this.parsedData={},this.context={lineCount:0,hasName:!1,nameLineIndex:-1,line1Index:-1,line2Index:-1,lines:[],recoveryAttempts:0}}addIssue(e,t,i,s={}){const n={severity:e,code:t,message:i,state:this.state,...s};return e===A.WARNING?this.warnings.push(n):this.errors.push(n),n}recordRecovery(e,t,i={}){this.recoveryActions.push({action:e,description:t,state:this.state,timestamp:Date.now(),...i}),this.context.recoveryAttempts++}transition(e,t=""){const i=this.state;return this.state=e,{from:i,to:e,reason:t}}parse(e){return this.reset(),"string"!=typeof e?(this.addIssue(A.CRITICAL,h.INVALID_INPUT_TYPE,"TLE data must be a string",{inputType:typeof e}),this.transition(I.ERROR),this.getResult()):0===e.length?(this.addIssue(A.CRITICAL,h.EMPTY_INPUT,"TLE string cannot be empty",{inputLength:0}),this.transition(I.ERROR),this.getResult()):(this.transition(I.DETECTING_FORMAT,"Starting parse"),this.detectFormat(e),this.state===I.DETECTING_FORMAT&&this.executeStateMachine(),this.getResult())}detectFormat(e){const t=e.trim().split("\n").map(e=>e.trim()).filter(e=>e.length>0);if(this.context.lines=t,this.context.lineCount=t.length,t.length<2)return this.addIssue(A.CRITICAL,h.INVALID_LINE_COUNT,`TLE must contain at least 2 lines (found ${t.length})`,{expected:"2 or 3",actual:t.length}),this.options.attemptRecovery&&this.recordRecovery(T.ABORT,"Insufficient lines to parse TLE",{lineCount:t.length}),void this.transition(I.ERROR);if(t.length>3){if(this.addIssue(A.ERROR,h.INVALID_LINE_COUNT,`TLE should contain 2 or 3 lines (found ${t.length})`,{expected:"2 or 3",actual:t.length}),this.options.attemptRecovery){this.recordRecovery(T.ATTEMPT_FIX,"Attempting to identify valid TLE lines from excess lines",{lineCount:t.length});const e=t.filter(e=>"1"===e[0]),i=t.filter(e=>"2"===e[0]);if(1===e.length&&1===i.length){const s=e[0],n=i[0];if(!s||!n)return;const r=t.indexOf(s),a=t.indexOf(n);if(r<a){r>0&&(this.context.hasName=!0,this.context.nameLineIndex=r-1),this.context.line1Index=r,this.context.line2Index=a;const e=t[this.context.nameLineIndex],i=t[r],s=t[a];this.context.lines=this.context.hasName&&e&&i&&s?[e,i,s]:i&&s?[i,s]:[],this.context.lineCount=this.context.lines.length,this.recordRecovery(T.CONTINUE,"Successfully identified TLE lines from excess input",{extractedLines:this.context.lineCount})}}}}else if(3===t.length){const e=t[0]?.[0];"1"!==e&&"2"!==e||this.addIssue(A.WARNING,h.SATELLITE_NAME_FORMAT_WARNING,'First line starts with "1" or "2", might be missing satellite name',{firstLine:t[0]}),this.context.hasName=!0,this.context.nameLineIndex=0,this.context.line1Index=1,this.context.line2Index=2}else this.context.hasName=!1,this.context.line1Index=0,this.context.line2Index=1}executeStateMachine(){let e=0;for(;this.state!==I.COMPLETED&&this.state!==I.ERROR&&e<100;){switch(this.state){case I.DETECTING_FORMAT:this.context.hasName?this.transition(I.PARSING_NAME):this.transition(I.PARSING_LINE1);break;case I.PARSING_NAME:this.parseSatelliteName(),this.transition(I.PARSING_LINE1);break;case I.PARSING_LINE1:this.parseLine1(),this.transition(I.PARSING_LINE2);break;case I.PARSING_LINE2:this.parseLine2(),this.transition(I.VALIDATING);break;case I.VALIDATING:this.validateCrossFields(),this.errors.some(e=>e.severity===A.CRITICAL)&&!this.options.includePartialResults?this.transition(I.ERROR):this.transition(I.COMPLETED);break;default:this.transition(I.ERROR,"Unexpected state")}e++}e>=100&&(this.addIssue(A.CRITICAL,"STATE_MACHINE_LOOP","State machine exceeded maximum iterations",{iterations:e}),this.transition(I.ERROR))}parseSatelliteName(){const e=this.context.nameLineIndex;if(e<0||e>=this.context.lines.length)return void this.addIssue(A.ERROR,"INVALID_NAME_LINE_INDEX","Invalid satellite name line index",{index:e});const t=this.context.lines[e];t&&(this.parsedData.satelliteName=t,t.length>24&&this.addIssue(A.WARNING,h.SATELLITE_NAME_TOO_LONG,"Satellite name exceeds recommended 24 characters",{length:t.length,name:t}),"1"!==t[0]&&"2"!==t[0]||this.addIssue(A.WARNING,h.SATELLITE_NAME_FORMAT_WARNING,'Satellite name starts with "1" or "2", might be incorrectly formatted',{name:t}))}parseLine1(){const e=this.context.line1Index;if(e<0||e>=this.context.lines.length)return void this.addIssue(A.CRITICAL,"INVALID_LINE1_INDEX","Invalid Line 1 index",{index:e});const t=this.context.lines[e];if(!t)return;if(this.parsedData.line1Raw=t,69!==t.length)if(this.addIssue(A.ERROR,h.INVALID_LINE_LENGTH,`Line 1 must be exactly 69 characters (got ${t.length})`,{line:1,expected:69,actual:t.length}),this.options.attemptRecovery)this.recordRecovery(T.CONTINUE,"Attempting to parse Line 1 despite incorrect length",{length:t.length});else if(this.options.strictMode)return;this.parseFieldSafe("lineNumber1",t,0,1,"Line 1 number"),this.parseFieldSafe("satelliteNumber1",t,2,7,"Satellite number"),this.parseFieldSafe("classification",t,7,8,"Classification"),this.parseFieldSafe("internationalDesignatorYear",t,9,11,"Int. designator year"),this.parseFieldSafe("internationalDesignatorLaunchNumber",t,11,14,"Int. designator launch"),this.parseFieldSafe("internationalDesignatorPiece",t,14,17,"Int. designator piece"),this.parseFieldSafe("epochYear",t,18,20,"Epoch year"),this.parseFieldSafe("epoch",t,20,32,"Epoch"),this.parseFieldSafe("firstDerivative",t,33,43,"First derivative"),this.parseFieldSafe("secondDerivative",t,44,52,"Second derivative"),this.parseFieldSafe("bStar",t,53,61,"B* drag term"),this.parseFieldSafe("ephemerisType",t,62,63,"Ephemeris type"),this.parseFieldSafe("elementSetNumber",t,64,68,"Element set number"),this.parseFieldSafe("checksum1",t,68,69,"Checksum"),"1"!==this.parsedData.lineNumber1&&this.addIssue(A.ERROR,h.INVALID_LINE_NUMBER,`Line 1 must start with '1' (got '${this.parsedData.lineNumber1}')`,{line:1,expected:"1",actual:this.parsedData.lineNumber1});const i=["U","C","S"];if(this.parsedData.classification&&!i.includes(this.parsedData.classification)&&this.addIssue(A.ERROR,h.INVALID_CLASSIFICATION,`Classification must be U, C, or S (got '${this.parsedData.classification}')`,{expected:i,actual:this.parsedData.classification}),69===t.length){const e=this.calculateChecksum(t),i=parseInt(this.parsedData.checksum1||"",10);isNaN(i)||e===i||(this.addIssue(A.ERROR,h.CHECKSUM_MISMATCH,`Line 1 checksum mismatch (expected ${e}, got ${i})`,{line:1,expected:e,actual:i}),this.options.attemptRecovery&&this.recordRecovery(T.CONTINUE,"Continuing despite checksum mismatch",{line:1}))}}parseLine2(){const e=this.context.line2Index;if(e<0||e>=this.context.lines.length)return void this.addIssue(A.CRITICAL,"INVALID_LINE2_INDEX","Invalid Line 2 index",{index:e});const t=this.context.lines[e];if(t){if(this.parsedData.line2Raw=t,69!==t.length)if(this.addIssue(A.ERROR,h.INVALID_LINE_LENGTH,`Line 2 must be exactly 69 characters (got ${t.length})`,{line:2,expected:69,actual:t.length}),this.options.attemptRecovery)this.recordRecovery(T.CONTINUE,"Attempting to parse Line 2 despite incorrect length",{length:t.length});else if(this.options.strictMode)return;if(this.parseFieldSafe("lineNumber2",t,0,1,"Line 2 number"),this.parseFieldSafe("satelliteNumber2",t,2,7,"Satellite number"),this.parseFieldSafe("inclination",t,8,16,"Inclination"),this.parseFieldSafe("rightAscension",t,17,25,"Right ascension"),this.parseFieldSafe("eccentricity",t,26,33,"Eccentricity"),this.parseFieldSafe("argumentOfPerigee",t,34,42,"Argument of perigee"),this.parseFieldSafe("meanAnomaly",t,43,51,"Mean anomaly"),this.parseFieldSafe("meanMotion",t,52,63,"Mean motion"),this.parseFieldSafe("revolutionNumber",t,63,68,"Revolution number"),this.parseFieldSafe("checksum2",t,68,69,"Checksum"),"2"!==this.parsedData.lineNumber2&&this.addIssue(A.ERROR,h.INVALID_LINE_NUMBER,`Line 2 must start with '2' (got '${this.parsedData.lineNumber2}')`,{line:2,expected:"2",actual:this.parsedData.lineNumber2}),69===t.length){const e=this.calculateChecksum(t),i=parseInt(this.parsedData.checksum2||"",10);isNaN(i)||e===i||(this.addIssue(A.ERROR,h.CHECKSUM_MISMATCH,`Line 2 checksum mismatch (expected ${e}, got ${i})`,{line:2,expected:e,actual:i}),this.options.attemptRecovery&&this.recordRecovery(T.CONTINUE,"Continuing despite checksum mismatch",{line:2}))}}}validateCrossFields(){if(this.parsedData.satelliteNumber1&&this.parsedData.satelliteNumber2){const e=this.parsedData.satelliteNumber1.trim(),t=this.parsedData.satelliteNumber2.trim();e!==t&&this.addIssue(A.ERROR,h.SATELLITE_NUMBER_MISMATCH,`Satellite numbers must match (Line 1: ${e}, Line 2: ${t})`,{line1Value:e,line2Value:t})}if(this.validateNumericField("inclination",0,180,"Inclination"),this.validateNumericField("rightAscension",0,360,"Right Ascension"),this.validateNumericField("argumentOfPerigee",0,360,"Argument of Perigee"),this.validateNumericField("meanAnomaly",0,360,"Mean Anomaly"),this.parsedData.eccentricity){const e=parseFloat("0."+this.parsedData.eccentricity.trim());!isNaN(e)&&(e<0||e>1)&&this.addIssue(A.ERROR,h.VALUE_OUT_OF_RANGE,`Eccentricity must be between 0 and 1 (got ${e})`,{field:"eccentricity",value:e,min:0,max:1})}this.validateNumericField("meanMotion",0,20,"Mean Motion",!0),this.validateNumericField("epochYear",0,99,"Epoch Year")}validateNumericField(e,t,i,s,n=!1){const r=this.parsedData[e];if(!r||"string"!=typeof r)return;const a=parseFloat(r.trim());isNaN(a)?this.addIssue(n?A.WARNING:A.ERROR,h.INVALID_NUMBER_FORMAT,`${s} must be numeric (got '${r}')`,{field:e,value:r}):(a<t||a>i)&&this.addIssue(n?A.WARNING:A.ERROR,h.VALUE_OUT_OF_RANGE,`${s} must be between ${t} and ${i} (got ${a})`,{field:e,value:a,min:t,max:i})}parseFieldSafe(e,t,i,s,n){try{t.length>=s?this.parsedData[e]=t.substring(i,s).trim():t.length>i?(this.parsedData[e]=t.substring(i).trim(),this.addIssue(A.WARNING,"PARTIAL_FIELD",`${n} is incomplete due to short line`,{field:e,expected:[i,s],actual:t.length}),this.options.attemptRecovery&&this.recordRecovery(T.USE_DEFAULT,`Using partial value for ${n}`,{field:e})):(this.parsedData[e]=null,this.addIssue(A.WARNING,"MISSING_FIELD",`${n} is missing due to short line`,{field:e,expected:[i,s],actual:t.length}),this.options.attemptRecovery&&this.recordRecovery(T.USE_DEFAULT,`Using null for missing ${n}`,{field:e}))}catch(t){this.parsedData[e]=null;const i=t instanceof Error?t.message:String(t);this.addIssue(A.ERROR,"FIELD_PARSE_ERROR",`Error parsing ${n}: ${i}`,{field:e,error:i})}}calculateChecksum(e){let t=0;for(let i=0;i<e.length-1;i++){const s=e[i];s&&s>="0"&&s<="9"?t+=parseInt(s,10):"-"===s&&(t+=1)}return t%10}getResult(){const e=this.errors.map(e=>({code:e.code,message:e.message,severity:e.severity===A.CRITICAL?"error":e.severity,...Object.fromEntries(Object.entries(e).filter(([e])=>!["severity","code","message","state"].includes(e)))})),t=this.warnings.map(e=>({code:e.code,message:e.message,severity:"warning",...Object.fromEntries(Object.entries(e).filter(([e])=>!["severity","code","message","state"].includes(e)))}));return{success:this.state===I.COMPLETED,state:this.state,data:this.parsedData,errors:e,warnings:t,recoveryActions:this.recoveryActions.map(e=>e.action),partialData:this.options.includePartialResults?this.parsedData:void 0,context:{lineCount:this.context.lineCount,hasName:this.context.hasName,recoveryAttempts:this.context.recoveryAttempts}}}}function O(e,t={}){return new b(t).parse(e)}const M=c(s);function w(e,t={}){const{filter:i,continueOnError:s=!1,limit:n,skip:r=0,onTLE:a,onError:o,...c}=t,l=[],u=x(e);let h=0;for(let e=0;e<u.length;e++){if(e<r)continue;if(void 0!==n&&h>=n)break;const t=u[e];if(t)try{const s=yt(t,c);if(i&&!V(s,i))continue;l.push(s),h++,a&&a(s,e)}catch(i){if(o&&o(i,e,t),!s)throw i}}return l}function x(e){const t=mt(e).split("\n").map(e=>e.trim()).filter(e=>e.length>0),i=[];let s=[];for(const e of t)e.startsWith("#")?s.length>0&&s.push(e):"1"===e[0]?(s.length>=2&&i.push(s.join("\n")),s=[e]):"2"===e[0]?s.push(e):s.length>=2?(i.push(s.join("\n")),s=[e]):0===s.length?s=[e]:s.push(e);return s.length>=2&&i.push(s.join("\n")),i}async function $(e,t={}){return Promise.resolve(yt(e,t))}async function U(e,t={}){return Promise.resolve(w(e,t))}async function F(e,t={}){return Promise.resolve(_t(e,t))}function V(e,t){if(void 0!==t.satelliteNumber){const i=e.satelliteNumber1||"";if("function"==typeof t.satelliteNumber){if(!t.satelliteNumber(i))return!1}else if(Array.isArray(t.satelliteNumber)){if(!t.satelliteNumber.includes(i))return!1}else if(i!==t.satelliteNumber)return!1}if(void 0!==t.satelliteName&&e.satelliteName){const i=e.satelliteName;if("function"==typeof t.satelliteName){if(!t.satelliteName(i))return!1}else if(Array.isArray(t.satelliteName)){if(!t.satelliteName.some(e=>i.includes(e)))return!1}else if(!i.includes(t.satelliteName))return!1}if(void 0!==t.intlDesignator){const i=`${e.internationalDesignatorYear||""}${e.internationalDesignatorLaunchNumber||""}${e.internationalDesignatorPiece||""}`.trim();if("function"==typeof t.intlDesignator){if(!t.intlDesignator(i))return!1}else if(Array.isArray(t.intlDesignator)){if(!t.intlDesignator.includes(i))return!1}else if(i!==t.intlDesignator)return!1}if(void 0!==t.classification){const i=e.classification;if(Array.isArray(t.classification)){if(!t.classification.includes(i))return!1}else if(i!==t.classification)return!1}if(t.epochRange){const i=parseInt(e.epochYear||"0",10),s=e.epoch||"0",n=parseFloat(s),r=new Date(i>=57?1900+i:2e3+i,0,1);if(r.setDate(r.getDate()+n-1),t.epochRange.start&&r<t.epochRange.start)return!1;if(t.epochRange.end&&r>t.epochRange.end)return!1}if(t.inclinationRange){const i=parseFloat(e.inclination||"0");if(void 0!==t.inclinationRange.min&&i<t.inclinationRange.min)return!1;if(void 0!==t.inclinationRange.max&&i>t.inclinationRange.max)return!1}return!(t.custom&&!t.custom(e))}class G extends l{constructor(e={}){super({objectMode:!0,highWaterMark:e.highWaterMark||16}),this.buffer="",this.index=0,this.options=e}_transform(e,t,i){this.buffer+=e.toString();const s=this.buffer.split("\n");this.buffer=s.pop()||"";let n=[];for(const e of s){const t=e.trim();0!==t.length&&(t.startsWith("#")?n.push(t):"1"===t[0]?(n.length>=2&&this.processTLE(n.join("\n")),n=[t]):"2"===t[0]?(n.push(t),n.length>=2&&(this.processTLE(n.join("\n")),n=[])):(n.length>=2&&this.processTLE(n.join("\n")),n=[t]))}i()}_flush(e){if(this.buffer.trim().length>0){const e=this.buffer.split("\n").filter(e=>e.trim().length>0);e.length>=2&&this.processTLE(e.join("\n"))}e()}processTLE(e){const{continueOnError:t=!0,filter:i,onTLE:s,onError:n,...r}=this.options;try{const t=yt(e,r);if(i&&!V(t,i))return;this.push(t),s&&s(t,this.index),this.index++}catch(i){n&&n(i,this.index,e),t||this.destroy(i),this.index++}}}function P(e={}){return new G(e)}async function k(e,t={}){const{encoding:i="utf8",...s}=t;return w(await M(e,{encoding:i}),s)}async function H(e,t={}){const{headers:i,timeout:s=3e4,...n}=t,r=new AbortController,a=setTimeout(()=>r.abort(),s);try{const t=await fetch(e,{headers:i,signal:r.signal});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return w(await t.text(),n)}finally{clearTimeout(a)}}async function W(e,t={}){return new Promise((i,s)=>{const n=[],r=P({...t,onTLE:(e,i)=>{n.push(e),t.onTLE&&t.onTLE(e,i)}});e.pipe(r).on("data",()=>{}).on("end",()=>i(n)).on("error",s)})}async function Y(e,t={}){const i=n(e),s=u();return W(i.pipe(s),t)}class B{constructor(){this.middlewares=[],this.plugins=[]}use(e){return this.middlewares.push(e),this}plugin(e){return this.plugins.push(e),e.middleware&&this.use(e.middleware),this}async parse(e,t={}){const i={rawTLE:e,options:t,metadata:{}},s=async e=>{if(e>=this.middlewares.length)return yt(i.rawTLE,i.options);const t=this.middlewares[e];return t?t(i,()=>s(e+1)):yt(i.rawTLE,i.options)};return s(0)}async parseBatch(e,t={}){for(const e of this.plugins)e.onBatchStart&&await e.onBatchStart(t);const i=[],s=x(e);for(let e=0;e<s.length;e++){const n=s[e];if(n)try{const s=await this.parse(n,t);if(t.filter&&!V(s,t.filter))continue;i.push(s);for(const t of this.plugins)t.onTLEParsed&&await t.onTLEParsed(s,e);t.onTLE&&t.onTLE(s,e)}catch(i){for(const t of this.plugins)t.onError&&await t.onError(i,e);if(t.onError&&t.onError(i,e,n),!t.continueOnError)throw i}}for(const e of this.plugins)e.onBatchEnd&&await e.onBatchEnd(i);return i}}function j(){return new B}class K{constructor(e={}){this.cache=new Map,this.maxSize=e.maxSize||1e3,this.ttl=e.ttl||36e5,this.keyGenerator=e.keyGenerator||this.defaultKeyGenerator}defaultKeyGenerator(e,t){return`${e}:${JSON.stringify(t)}`}get(e,t={}){const i=this.keyGenerator(e,t),s=this.cache.get(i);return s?Date.now()-s.timestamp>this.ttl?(this.cache.delete(i),null):(this.cache.delete(i),this.cache.set(i,s),s.tle):null}set(e,t,i={}){const s=this.keyGenerator(e,i);if(this.cache.size>=this.maxSize){const e=this.cache.keys().next().value;e&&this.cache.delete(e)}this.cache.set(s,{tle:t,timestamp:Date.now()})}clear(){this.cache.clear()}size(){return this.cache.size}}function q(e={}){const t=new K(e);return{parse:(e,i={})=>{const s=t.get(e,i);if(s)return s;const n=yt(e,i);return t.set(e,n,i),n},parseAsync:async(e,i={})=>{const s=t.get(e,i);if(s)return s;const n=await $(e,i);return t.set(e,n,i),n},cache:t}}function z(e){return{strict:{validate:!0,strictChecksums:!0,validateRanges:!0,mode:"strict",includeWarnings:!0,includeComments:!0},permissive:{validate:!0,strictChecksums:!1,validateRanges:!1,mode:"permissive",includeWarnings:!0,includeComments:!0},fast:{validate:!1,includeWarnings:!1,includeComments:!1},realtime:{validate:!0,strictChecksums:!1,validateRanges:!1,mode:"permissive",includeWarnings:!1,includeComments:!1},batch:{validate:!0,strictChecksums:!0,validateRanges:!0,mode:"strict",includeWarnings:!1,includeComments:!1},recovery:{validate:!1,includeWarnings:!0,includeComments:!0},legacy:{validate:!0,strictChecksums:!1,validateRanges:!1,mode:"permissive",includeWarnings:!0,includeComments:!0}}[e]}function X(e,t){return yt(e,z(t))}class Z{constructor(e,t={}){this.buffer="",this.currentSet=[],this.onTLE=e,this.options=t}push(e){this.buffer+=e,this.processBuffer()}flush(){this.currentSet.length>=2&&(this.emitTLE(this.currentSet.join("\n")),this.currentSet=[])}processBuffer(){const e=this.buffer.split("\n");this.buffer=e.pop()||"";for(const t of e){const e=t.trim();0!==e.length&&(e.startsWith("#")?this.currentSet.push(e):"1"===e[0]?(this.currentSet.length>=2&&this.emitTLE(this.currentSet.join("\n")),this.currentSet=[e]):"2"===e[0]?(this.currentSet.push(e),this.currentSet.length>=2&&(this.emitTLE(this.currentSet.join("\n")),this.currentSet=[])):(this.currentSet.length>=2&&this.emitTLE(this.currentSet.join("\n")),this.currentSet=[e]))}}emitTLE(e){try{const t=yt(e,this.options);this.onTLE(t)}catch(e){}}}function J(e,t={}){return new Z(e,t)}async function Q(e,t={},i){return w(e,t)}function ee(e){return{celestrak:{validate:!0,strictChecksums:!0,validateRanges:!0,mode:"strict",includeWarnings:!0,includeComments:!0},spacetrack:{validate:!0,strictChecksums:!0,validateRanges:!0,mode:"strict",includeWarnings:!0,includeComments:!0},amsat:{validate:!0,strictChecksums:!1,validateRanges:!1,mode:"permissive",includeWarnings:!0,includeComments:!0},custom:{validate:!1,includeWarnings:!0,includeComments:!0}}[e]}function te(e,t){return yt(e,ee(t))}const ie={meanMotion:{min:0,max:20,typical:{min:10,max:17}},eccentricity:{min:0,max:.999999,typical:{min:0,max:.25}},inclination:{min:0,max:180,typical:{min:0,max:100}},rightAscension:{min:0,max:360},argumentOfPerigee:{min:0,max:360},meanAnomaly:{min:0,max:360},bStar:{min:-1,max:1,typical:{min:-.001,max:.001}},meanMotionFirstDerivative:{min:-1,max:1,typical:{min:-.001,max:.001}},meanMotionSecondDerivative:{min:-1,max:1,typical:{min:-1e-5,max:1e-5}},revolutionNumber:{min:0,max:99999},elementSetNumber:{min:0,max:999},ephemerisType:{min:0,max:9}},se={min:1,max:999999,historical5Digit:99999,modern6Digit:999999},ne={minYear:57,maxYear:99,minDayOfYear:1,maxDayOfYear:366.99999999,warningAgeThreshold:7,criticalAgeThreshold:30,maxFutureDays:30},re={yearMin:57,yearMax:99,launchNumberMin:1,launchNumberMax:999,piecePattern:/^[A-Z]{1,3}$/},ae={checksumValid:20,fieldFormatValid:15,parametersInRange:15,parametersInTypicalRange:10,epochRecent:15,noAnomalies:10,designatorValid:5,consistencyChecks:10};function oe(e,t){let i;i=e>=57?1900+e:2e3+e;const s=new Date(Date.UTC(i,0,1)).getTime()+864e5*(t-1),n=new Date(s),r=Math.floor((14-(n.getUTCMonth()+1))/12),a=i+4800-r,o=n.getUTCMonth()+1+12*r-3,c=n.getUTCDate()+Math.floor((153*o+2)/5)+365*a+Math.floor(a/4)-Math.floor(a/100)+Math.floor(a/400)-32045+(n.getUTCHours()+n.getUTCMinutes()/60+n.getUTCSeconds()/3600)/24,l=c-2400000.5;return{year:i,twoDigitYear:e,dayOfYear:t,isoDate:n.toISOString(),date:n,julianDate:c,modifiedJulianDate:l}}function ce(e,t){const i=[];if((e<ne.minYear||e>ne.maxYear)&&i.push(`Epoch year ${e} outside valid range [${ne.minYear}, ${ne.maxYear}]`),(t<ne.minDayOfYear||t>ne.maxDayOfYear)&&i.push(`Epoch day ${t} outside valid range [${ne.minDayOfYear}, ${ne.maxDayOfYear}]`),i.length>0)return{valid:!1,message:i.join("; "),context:{epochYear:e,epochDay:t}};const s=oe(e,t),n=s.year,r=n%4==0&&n%100!=0||n%400==0,a=r?366:365;return Math.floor(t)>a&&i.push(`Day ${Math.floor(t)} exceeds maximum for ${n} (${r?"leap year":"non-leap year"}: ${a} days)`),i.length>0?{valid:!1,message:i.join("; "),context:{epochYear:e,epochDay:t,fullYear:n,isLeapYear:r}}:{valid:!0,context:{epochDate:s}}}function le(e,t,i=new Date){const s=oe(e,t);return(i.getTime()-s.date.getTime())/864e5}function ue(e,t,i={}){const s=le(e,t,i.referenceDate||new Date),n=[];if(s<0){const e=Math.abs(s);if(!i.allowFuture)return{valid:!1,message:`Epoch is ${e.toFixed(2)} days in the future`,context:{age:s,futureDays:e}};e>ne.maxFutureDays&&n.push(`Epoch is ${e.toFixed(2)} days in the future (threshold: ${ne.maxFutureDays} days)`)}if(s>0){const e=i.maxAge||ne.criticalAgeThreshold;s>e&&n.push(`Epoch is ${s.toFixed(2)} days old (threshold: ${e} days)`)}return{valid:!0,message:n.length>0?n.join("; "):void 0,context:{age:s}}}function he(e,t,i=!1){const s=ie[e];if(!s)return{valid:!1,message:`Unknown parameter: ${e}`};if(t<s.min||t>s.max)return{valid:!1,message:`${e} value ${t} outside valid range [${s.min}, ${s.max}]`,context:{paramName:e,value:t,min:s.min,max:s.max}};if(i&&"typical"in s&&s.typical){const i=s.typical;if(t<i.min||t>i.max)return{valid:!0,message:`${e} value ${t} outside typical range [${i.min}, ${i.max}]`,context:{paramName:e,value:t,typicalMin:i.min,typicalMax:i.max,outsideTypical:!0}}}return{valid:!0,context:{paramName:e,value:t}}}function me(e,t=!1){const i=[],s={meanMotion:{field:"meanMotion",param:"meanMotion"},eccentricity:{field:"eccentricity",param:"eccentricity"},inclination:{field:"inclination",param:"inclination"},rightAscension:{field:"rightAscension",param:"rightAscension"},argumentOfPerigee:{field:"argumentOfPerigee",param:"argumentOfPerigee"},meanAnomaly:{field:"meanAnomaly",param:"meanAnomaly"},bStar:{field:"bStar",param:"bStar"},firstDerivative:{field:"firstDerivative",param:"meanMotionFirstDerivative"},secondDerivative:{field:"secondDerivative",param:"meanMotionSecondDerivative"},revolutionNumber:{field:"revolutionNumber",param:"revolutionNumber"},elementSetNumber:{field:"elementSetNumber",param:"elementSetNumber"},ephemerisType:{field:"ephemerisType",param:"ephemerisType"}};for(const[n,r]of Object.entries(s)){const s=parseFloat(e[r.field]);if(isNaN(s)){i.push({valid:!1,message:`Field ${n} is not a valid number`,context:{field:n,value:e[r.field]}});continue}const a=he(r.param,s,t);a.valid&&!a.message||i.push({...a,context:{...a.context,field:n}})}return i}function de(e,t){if(e.length<69)return{valid:!1,message:`Line ${t} is too short (${e.length} chars, expected 69)`,context:{lineNumber:t,length:e.length}};const i=e.charAt(68),s=parseInt(i,10),n=function(e){let t=0;const i=e.substring(0,68);for(const e of i)e>="0"&&e<="9"?t+=parseInt(e,10):"-"===e&&(t+=1);return t%10}(e);return isNaN(s)?{valid:!1,message:`Line ${t} checksum is not a digit: '${i}'`,context:{lineNumber:t,checksumChar:i}}:n!==s?{valid:!1,message:`Line ${t} checksum mismatch: expected ${s}, calculated ${n}`,context:{lineNumber:t,expected:s,calculated:n,line:e.substring(0,68)}}:{valid:!0,context:{lineNumber:t,checksum:n}}}function pe(e){const t="-"===(e=e.trim())[0]?-1:1,i=e.replace(/^[-+\s]+/,"").replace(/\s+/g,""),s=i.match(/([+-])(\d+)$/);if(!s)return t*parseFloat("0."+i);const n=i.substring(0,i.length-s[0].length),r="-"===(s[1]||"+")?-1:1,a=parseInt(s[2]||"0",10);return t*parseFloat("0."+n)*Math.pow(10,r*a)}function ge(e,t="standard"){return"assumedDecimal"===t?pe(e):"integer"===t?parseInt(e.trim(),10):parseFloat(e.trim())}function Ne(e){const t="string"==typeof e?parseInt(e.trim(),10):e;return isNaN(t)?{valid:!1,message:`Satellite number is not a valid integer: '${e}'`,context:{satelliteNumber:e}}:t<se.min||t>se.max?{valid:!1,message:`Satellite number ${t} outside valid range [${se.min}, ${se.max}]`,context:{satelliteNumber:t,min:se.min,max:se.max}}:{valid:!0,context:{satelliteNumber:t,format:t<=se.historical5Digit?"5-digit":"6-digit"}}}function fe(e){const t=e.trim(),i=t.match(/^(\d{2})(\d{1,3})([A-Z]{1,3})$/);if(!i)return{valid:!1,message:`Invalid international designator format: '${e}' (expected YYLLLPPP)`,context:{designator:t}};const s=i[1]||"0",n=i[2]||"0",r=i[3]||"",a=parseInt(s,10),o=parseInt(n,10);return a<re.yearMin||a>re.yearMax?{valid:!1,message:`International designator year ${a} outside valid range [${re.yearMin}, ${re.yearMax}]`,context:{designator:t,year:a}}:o<re.launchNumberMin||o>re.launchNumberMax?{valid:!1,message:`International designator launch number ${o} outside valid range [${re.launchNumberMin}, ${re.launchNumberMax}]`,context:{designator:t,launchNumber:o}}:re.piecePattern.test(r)?{valid:!0,context:{designator:t,year:a,launchNumber:o,piece:r,fullYear:a>=re.yearMin?1900+a:2e3+a}}:{valid:!1,message:`International designator piece '${r}' invalid (must be 1-3 uppercase letters)`,context:{designator:t,piece:r}}}const Ee=.01,Ie=.01;function Ae(e){const t=[],i=parseFloat(e.eccentricity),s=parseFloat(e.meanMotion),n=parseFloat(e.inclination),r=pe(e.bStar),a=parseFloat(e.firstDerivative),o=parseInt(e.revolutionNumber,10);return i>.5&&t.push({hasAnomaly:!0,type:"HIGH_ECCENTRICITY",description:`Unusually high eccentricity: ${i.toFixed(6)} (threshold: 0.5)`,severity:i>.9?"error":"warning",score:Math.min(i/.5,1)}),s<1&&t.push({hasAnomaly:!0,type:"LOW_MEAN_MOTION",description:`Unusually low mean motion: ${s.toFixed(8)} rev/day (threshold: 1)`,severity:"warning",score:1-s/1}),s>18&&t.push({hasAnomaly:!0,type:"HIGH_MEAN_MOTION",description:`Unusually high mean motion: ${s.toFixed(8)} rev/day (threshold: 18)`,severity:"warning",score:Math.min(s/18,1)}),n>90&&n<180&&t.push({hasAnomaly:!0,type:"RETROGRADE_ORBIT",description:`Retrograde orbit detected: inclination ${n.toFixed(4)}Â° (>90Â°)`,severity:"info",score:(n-90)/90}),Math.abs(r)>Ee&&t.push({hasAnomaly:!0,type:"HIGH_DRAG",description:`Unusually high drag coefficient: B* = ${r.toExponential(4)} (threshold: 0.01)`,severity:"warning",score:Math.min(Math.abs(r)/Ee,1)}),Math.abs(a)>Ie&&t.push({hasAnomaly:!0,type:"RAPID_ORBITAL_CHANGE",description:`Rapid orbital evolution: dn/dt = ${a.toFixed(8)} (threshold: 0.01)`,severity:"warning",score:Math.min(Math.abs(a)/Ie,1)}),o<100&&t.push({hasAnomaly:!0,type:"NEW_SATELLITE",description:`Recently launched satellite: revolution number ${o}`,severity:"info",score:1-o/100}),0===i&&t.push({hasAnomaly:!0,type:"CIRCULAR_ORBIT",description:"Perfect circular orbit (eccentricity = 0)",severity:"info",score:.1}),t}function Te(e,t){let i=0;const s={checksumScore:0,formatScore:0,rangeScore:0,epochScore:0,anomalyScore:0,consistencyScore:0};t.checksumValid&&(s.checksumScore=ae.checksumValid),t.formatValid&&(s.formatScore=ae.fieldFormatValid);const n=t.rangeErrors.filter(e=>!e.valid),r=t.rangeResults.filter(e=>e.valid&&e.message);if(0===n.length)s.rangeScore=ae.parametersInRange,0===r.length&&(s.rangeScore+=ae.parametersInTypicalRange);else{const e=n.length+r.length,t=r.length;s.rangeScore=t/e*ae.parametersInRange}const a=Math.abs(t.epochAge);s.epochScore=a<=1?ae.epochRecent:a<=ne.warningAgeThreshold?.9*ae.epochRecent:a<=ne.criticalAgeThreshold?.5*ae.epochRecent:.2*ae.epochRecent;const o={error:1,warning:.5,info:.1},c=t.anomalies.reduce((e,t)=>{const i=o[t.severity||"info"];return e+(t.score||.5)*i},0);s.anomalyScore=Math.max(0,ae.noAnomalies-2*c);let l,u,h=ae.consistencyChecks;return e.satelliteNumber1!==e.satelliteNumber2&&(h-=5),["U","C","S"].includes(e.classification)||(h-=2),fe(e.internationalDesignatorYear+e.internationalDesignatorLaunchNumber+e.internationalDesignatorPiece).valid||(h-=3),s.consistencyScore=Math.max(0,h),i=Object.values(s).reduce((e,t)=>e+t,0),l=i>=90?"A":i>=80?"B":i>=70?"C":i>=60?"D":"F",u="A"===l?"Excellent quality - TLE is fresh, valid, and anomaly-free":"B"===l?"Good quality - TLE is valid with minor warnings":"C"===l?"Acceptable quality - TLE has some issues but is usable":"D"===l?"Poor quality - TLE has significant issues, use with caution":"Invalid - TLE has critical errors and should not be used",{overall:Math.round(i),components:s,grade:l,assessment:u}}function Re(e,t){let i=e;const s=[];i.includes("\0")&&(i=i.replace(/\0/g,""),s.push("Removed null bytes")),i.includes("\t")&&(i=i.replace(/\t/g," "),s.push("Normalized tabs to spaces"));const n=/[\x00-\x1F\x7F-\x9F]/g;switch(n.test(i)&&(i=i.replace(n,""),s.push("Removed non-printable characters")),t){case"satelliteName":/^[A-Z0-9\s\-\(\)]+$/i.test(i)||(i=i.replace(/[^A-Z0-9\s\-\(\)]/gi,""),s.push("Removed invalid characters from satellite name"));break;case"classification":i=i.trim().toUpperCase(),i.length>1&&(i=i.charAt(0),s.push("Truncated classification to single character"));break;case"internationalDesignatorYear":case"internationalDesignatorLaunchNumber":case"satelliteNumber1":case"satelliteNumber2":case"elementSetNumber":case"revolutionNumber":/^\d+$/.test(i.trim())||(i=i.replace(/\D/g,""),s.push(`Removed non-numeric characters from ${t}`));break;case"internationalDesignatorPiece":{const e=i;i=i.trim().toUpperCase().replace(/[^A-Z]/g,""),i!==e.trim()&&s.push("Normalized designator piece to uppercase letters");break}}const r=i.trim();return r!==i&&(i=r,s.push("Trimmed whitespace")),{value:i,modified:s.length>0,modifications:s.length>0?s:void 0}}function Le(e){const t=new Map;for(const[i,s]of Object.entries(e))if("string"==typeof s){const e=Re(s,i);e.modified&&t.set(i,e)}return t}const _e=[{name:"checksum",description:"Validate line checksums",severity:"error",enabled:!0,validate:()=>({valid:!0})},{name:"satelliteNumberRange",description:"Validate satellite number is in valid range",severity:"error",enabled:!0,validate:e=>Ne(e)},{name:"epochDate",description:"Validate epoch date format and range",severity:"error",enabled:!0,validate:e=>ce(parseInt(e.epochYear,10),parseFloat(e.epoch))},{name:"epochAge",description:"Warn if epoch is stale or in future",severity:"warning",enabled:!0,validate:(e,t)=>ue(parseInt(e.epochYear,10),parseFloat(e.epoch),{referenceDate:t?.referenceDate})},{name:"internationalDesignator",description:"Validate international designator format",severity:"warning",enabled:!0,validate:e=>fe(e.internationalDesignatorYear+e.internationalDesignatorLaunchNumber+e.internationalDesignatorPiece)},{name:"orbitalParameterRanges",description:"Validate orbital parameters are in valid ranges",severity:"error",enabled:!0,validate:e=>{const t=me(e,!1).filter(e=>!e.valid);return t.length>0?{valid:!1,message:t.map(e=>e.message).join("; "),context:{errors:t}}:{valid:!0}}},{name:"anomalyDetection",description:"Detect unusual orbital parameters",severity:"warning",enabled:!1,validate:e=>{const t=Ae(e);return t.length>0?{valid:!0,message:`${t.length} anomalies detected`,context:{anomalies:t}}:{valid:!0}}}];function ye(e,t,i,s={}){return{name:e,description:t,severity:s.severity||"warning",enabled:!1!==s.enabled,validate:i,errorMessage:s.errorMessage}}class Se{constructor(e=_e){this.rules=new Map;for(const t of e)this.rules.set(t.name,t)}addRule(e){this.rules.set(e.name,e)}removeRule(e){return this.rules.delete(e)}enableRule(e){const t=this.rules.get(e);return!!t&&(t.enabled=!0,!0)}disableRule(e){const t=this.rules.get(e);return!!t&&(t.enabled=!1,!0)}getEnabledRules(){return Array.from(this.rules.values()).filter(e=>e.enabled)}getRule(e){return this.rules.get(e)}getAllRules(){return Array.from(this.rules.values())}}function ve(e,t,i={}){const s=[],n=[],r=[],a=[],o=[];let c=0,l=0,u=0;if(!1!==i.validateChecksums){c+=2,o.push("checksum");const e=de(t.line1,1);e.valid?l++:(s.push({code:"CHECKSUM_MISMATCH",message:e.message||"Checksum validation failed",line:1,severity:"error",field:"checksum1"}),u++);const i=de(t.line2,2);i.valid?l++:(s.push({code:"CHECKSUM_MISMATCH",message:i.message||"Checksum validation failed",line:2,severity:"error",field:"checksum2"}),u++)}if(!1!==i.validateEpoch){c++,o.push("epochDate");const t=parseInt(e.epochYear,10),r=parseFloat(e.epoch),a=ce(t,r);a.valid?l++:(s.push({code:"INVALID_EPOCH",message:a.message||"Invalid epoch date",severity:"error",field:"epoch"}),u++);const h=ue(t,r,{referenceDate:i.referenceDate,allowFuture:i.allowFutureEpochs,maxAge:i.maxEpochAge});h.valid?h.message&&n.push({code:"STALE_EPOCH",message:h.message,severity:"warning",field:"epoch"}):s.push({code:"EPOCH_OUT_OF_RANGE",message:h.message||"Epoch age out of acceptable range",severity:"error",field:"epoch"})}const h={valid:[],invalid:[]};if(!1!==i.validateRanges){o.push("orbitalParameterRanges");const t=me(e,i.strict);c+=t.length;for(const e of t)e.valid?e.message?(n.push({code:"PARAMETER_OUTSIDE_TYPICAL",message:e.message,severity:"warning",field:e.context?.field}),l++,h.valid.push(e)):(l++,h.valid.push(e)):(s.push({code:"PARAMETER_OUT_OF_RANGE",message:e.message||"Parameter out of valid range",severity:"error",field:e.context?.field}),u++,h.invalid.push(e))}if(i.detectAnomalies&&(o.push("anomalyDetection"),r.push(...Ae(e))),i.sanitizeFields){o.push("fieldSanitization");const t=Le(e);for(const[e]of t)a.push(e)}c++,o.push("satelliteNumber");const m=Ne(e.satelliteNumber1);m.valid?l++:(s.push({code:"INVALID_SATELLITE_NUMBER",message:m.message||"Invalid satellite number",severity:"error",field:"satelliteNumber"}),u++),e.satelliteNumber1!==e.satelliteNumber2&&n.push({code:"SATELLITE_NUMBER_MISMATCH",message:`Satellite numbers do not match: ${e.satelliteNumber1} vs ${e.satelliteNumber2}`,severity:"warning",field:"satelliteNumber"}),c++,o.push("internationalDesignator");const d=fe(e.internationalDesignatorYear+e.internationalDesignatorLaunchNumber+e.internationalDesignatorPiece);let p;if(d.valid?l++:(n.push({code:"INVALID_DESIGNATOR",message:d.message||"Invalid international designator",severity:"warning",field:"internationalDesignator"}),u++),!1!==i.calculateQuality){const t=le(parseInt(e.epochYear,10),parseFloat(e.epoch),i.referenceDate);p=Te(e,{checksumValid:0===s.filter(e=>"CHECKSUM_MISMATCH"===e.code).length,formatValid:0===s.filter(e=>e.code?.includes("FORMAT")).length,rangeErrors:h.invalid,rangeResults:[...h.valid,...h.invalid],epochAge:t,anomalies:r})}else p={overall:0,components:{checksumScore:0,formatScore:0,rangeScore:0,epochScore:0,anomalyScore:0,consistencyScore:0},grade:"F",assessment:"Not calculated"};return{isValid:0===s.length,qualityScore:p,errors:s,warnings:n,anomalies:r,sanitizedFields:a,timestamp:new Date,rulesApplied:o,summary:{totalChecks:c,passedChecks:l,failedChecks:u,warningCount:n.length,errorCount:s.length}}}function Ce(e){return e.satelliteNumber1||e.satelliteNumber2||""}function De(e){return`${e.internationalDesignatorYear||""}${e.internationalDesignatorLaunchNumber||""}${e.internationalDesignatorPiece||""}`.trim()}const be={reset:"[0m",bright:"[1m",dim:"[2m",black:"[30m",red:"[31m",green:"[32m",yellow:"[33m",blue:"[34m",magenta:"[35m",cyan:"[36m",white:"[37m",bgBlack:"[40m",bgRed:"[41m",bgGreen:"[42m",bgYellow:"[43m",bgBlue:"[44m",bgMagenta:"[45m",bgCyan:"[46m",bgWhite:"[47m"};function Oe(e,t,i=!0){return i?`${t}${e}${be.reset}`:e}function Me(e,t={}){const{pretty:i=!1,includeWarnings:s=!0,includeComments:n=!0,verbosity:r="normal"}=t,a=e=>{const t={...e};return!s&&"warnings"in t&&delete t.warnings,!n&&"comments"in t&&delete t.comments,"compact"===r?{satelliteName:t.satelliteName,satelliteNumber:Ce(t),epoch:t.epochYear+":"+t.epoch,inclination:t.inclination,eccentricity:t.eccentricity,meanMotion:t.meanMotion}:t},o=Array.isArray(e)?e.map(a):a(e);return JSON.stringify(o,null,i?2:0)}function we(e,t={}){const{includeHeader:i=!0,delimiter:s=",",quote:n=!0,verbosity:r="normal"}=t,a=Array.isArray(e)?e:[e],o=[],c=Object.keys(a[0]||{}).filter(e=>!["warnings","comments","checksum1","checksum2","lineNumber1","lineNumber2"].includes(e)),l="compact"===r?["satelliteName","satelliteNumber1","epochYear","epoch","inclination","eccentricity","meanMotion"]:"verbose"===r?c:["satelliteName","satelliteNumber1","classification","epochYear","epoch","firstDerivative","secondDerivative","bStar","inclination","rightAscension","eccentricity","argumentOfPerigee","meanAnomaly","meanMotion","revolutionNumber"];i&&o.push(l.map(e=>n?`"${e}"`:e).join(s));for(const e of a){const t=l.map(t=>{const i=e[t]??"",s=String(i);return n?`"${s.replace(/"/g,'""')}"`:s});o.push(t.join(s))}return o.join("\n")}function xe(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function $e(e,t={}){const{pretty:i=!1,includeWarnings:s=!0,includeComments:n=!0}=t,r=i?"  ":"",a=i?"\n":"",o=Array.isArray(e)?e:[e],c=['<?xml version="1.0" encoding="UTF-8"?>'];c.push(`<tles>${a}`);for(const e of o){c.push(`${r}<tle>${a}`);for(const[t,i]of Object.entries(e))if(("warnings"!==t||s)&&("comments"!==t||n))if(Array.isArray(i)){c.push(`${r}${r}<${t}>${a}`);for(const e of i){const t="object"==typeof e?JSON.stringify(e):String(e);c.push(`${r}${r}${r}<item>${xe(t)}</item>${a}`)}c.push(`${r}${r}</${t}>${a}`)}else{const e=xe(String(i??""));c.push(`${r}${r}<${t}>${e}</${t}>${a}`)}c.push(`${r}</tle>${a}`)}return c.push("</tles>"),c.join("")}function Ue(e,t={}){const{includeWarnings:i=!0,includeComments:s=!0}=t,n=Array.isArray(e)?e:[e],r=[],a=(e,t=0)=>{const i="  ".repeat(t);return null==e?"null":"string"==typeof e?/[:#\[\]{},&*!|>'"%@`]/.test(e)||/^\s|\s$/.test(e)?`"${e.replace(/"/g,'\\"')}"`:e:"number"==typeof e||"boolean"==typeof e?String(e):Array.isArray(e)?0===e.length?"[]":"\n"+e.map(e=>{if("object"==typeof e&&null!==e){const s=o(e,t+1);return`${i}  -${s.substring(i.length+3)}`}return`${i}  - ${a(e,0)}`}).join("\n"):"object"==typeof e?"\n"+o(e,t+1):String(e)},o=(e,t=0)=>{const n="  ".repeat(t),r=[];for(const[o,c]of Object.entries(e)){if("warnings"===o&&!i)continue;if("comments"===o&&!s)continue;const e=a(c,t);e.startsWith("\n")?r.push(`${n}${o}:${e}`):r.push(`${n}${o}: ${e}`)}return r.join("\n")};if(1===n.length)return o(n[0],0);r.push("tles:");for(const e of n){r.push("  -");const t=o(e,2);r.push(t)}return r.join("\n")}function Fe(e,t={}){const{colors:i=!1,verbosity:s="normal",includeWarnings:n=!0}=t,r=[];if(r.push(Oe("â•".repeat(70),be.cyan,i)),r.push(Oe(`  ${e.satelliteName||"Unknown Satellite"}`,be.bright+be.cyan,i)),r.push(Oe("â•".repeat(70),be.cyan,i)),r.push(""),r.push(Oe("Basic Information:",be.bright+be.yellow,i)),r.push(`  ${Oe("Satellite Number:",be.green,i)} ${Ce(e)}`),r.push(`  ${Oe("Classification:",be.green,i)} ${e.classification||"N/A"}`),r.push(`  ${Oe("International Designator:",be.green,i)} ${De(e)||"N/A"}`),r.push(""),r.push(Oe("Epoch Information:",be.bright+be.yellow,i)),r.push(`  ${Oe("Epoch Year:",be.green,i)} ${e.epochYear}`),r.push(`  ${Oe("Epoch Day:",be.green,i)} ${e.epoch}`),r.push(""),r.push(Oe("Orbital Parameters:",be.bright+be.yellow,i)),r.push(`  ${Oe("Inclination:",be.green,i)} ${e.inclination}Â°`),r.push(`  ${Oe("Right Ascension:",be.green,i)} ${e.rightAscension}Â°`),r.push(`  ${Oe("Eccentricity:",be.green,i)} ${e.eccentricity}`),r.push(`  ${Oe("Argument of Perigee:",be.green,i)} ${e.argumentOfPerigee}Â°`),r.push(`  ${Oe("Mean Anomaly:",be.green,i)} ${e.meanAnomaly}Â°`),r.push(`  ${Oe("Mean Motion:",be.green,i)} ${e.meanMotion} rev/day`),r.push(""),"verbose"===s&&(r.push(Oe("Additional Parameters:",be.bright+be.yellow,i)),r.push(`  ${Oe("First Derivative (Mean Motion):",be.green,i)} ${e.firstDerivative}`),r.push(`  ${Oe("Second Derivative (Mean Motion):",be.green,i)} ${e.secondDerivative}`),r.push(`  ${Oe("B* Drag Term:",be.green,i)} ${e.bStar}`),r.push(`  ${Oe("Ephemeris Type:",be.green,i)} ${e.ephemerisType}`),r.push(`  ${Oe("Element Set Number:",be.green,i)} ${e.elementSetNumber}`),r.push(`  ${Oe("Revolution Number:",be.green,i)} ${e.revolutionNumber}`),r.push("")),n&&"warnings"in e&&Array.isArray(e.warnings)&&e.warnings.length>0){r.push(Oe("Warnings:",be.bright+be.yellow,i));for(const t of e.warnings){const e="object"==typeof t&&"message"in t?t.message:String(t);r.push(`  ${Oe("âš ",be.yellow,i)} ${e}`)}r.push("")}return r.push(Oe("â•".repeat(70),be.cyan,i)),r.join("\n")}function Ve(e,t={}){const{includeName:i=!0}=t,s=(e,t)=>e.padEnd(t," "),n=(e,t,i=" ")=>e.padStart(t,i);let r="1 ";r+=n(Ce(e),5," "),r+=e.classification||"U",r+=" "+s(De(e),8),r+=" "+n(e.epochYear||"",2,"0"),r+=n(e.epoch||"",12," "),r+=" "+n(e.firstDerivative||"",10," "),r+=" "+s(e.secondDerivative||"",8),r+=" "+s(e.bStar||"",8),r+=" "+(e.ephemerisType||"0"),r+=" "+n(e.elementSetNumber||"",4," ");let a=0;for(let e=0;e<r.length;e++){const t=r[e];t&&t>="0"&&t<="9"?a+=parseInt(t,10):"-"===t&&(a+=1)}r+=(a%10).toString();let o="2 ";o+=n(Ce(e),5," "),o+=" "+n(e.inclination||"",8," "),o+=" "+n(e.rightAscension||"",8," "),o+=" "+n((e.eccentricity||"").replace(/^0\./,""),7,"0"),o+=" "+n(e.argumentOfPerigee||"",8," "),o+=" "+n(e.meanAnomaly||"",8," "),o+=" "+n(e.meanMotion||"",11," "),o+=n(e.revolutionNumber||"",5," ");let c=0;for(let e=0;e<o.length;e++){const t=o[e];t&&t>="0"&&t<="9"?c+=parseInt(t,10):"-"===t&&(c+=1)}o+=(c%10).toString();const l=[];return i&&e.satelliteName&&l.push(e.satelliteName),l.push(r),l.push(o),l.join("\n")}function Ge(e,t={}){const{format:i="json"}=t;switch(i){case"json":return Me(e,t);case"csv":return we(e,t);case"xml":return $e(e,t);case"yaml":return Ue(e,t);case"human":return Array.isArray(e)?e.map(e=>Fe(e,t)).join("\n\n"):Fe(e,t);case"tle":return Array.isArray(e)?e.map(e=>Ve(e,{includeName:!0})).join("\n\n"):Ve(e,{includeName:!0});default:throw new Error(`Unsupported output format: ${i}`)}}class Pe{constructor(e){this.config=e,this.queue=[],this.processing=!1,this.tokens=e.maxRequests,this.lastRefill=Date.now()}refillTokens(){const e=Date.now(),t=(e-this.lastRefill)/this.config.intervalMs*this.config.maxRequests;t>=1&&(this.tokens=Math.min(this.config.maxRequests,this.tokens+Math.floor(t)),this.lastRefill=e)}async processQueue(){if(!this.processing){for(this.processing=!0;this.queue.length>0;)if(this.refillTokens(),this.tokens>=1){const e=this.queue.shift();e&&(this.tokens-=1,e.resolve())}else{const e=this.config.intervalMs-(Date.now()-this.lastRefill);e>0&&await new Promise(t=>setTimeout(t,e))}this.processing=!1}}async acquire(){if(this.refillTokens(),this.tokens>=1)return this.tokens-=1,Promise.resolve();if(this.config.maxQueueSize&&this.queue.length>=this.config.maxQueueSize)throw new Error("Rate limiter queue is full");return new Promise((e,t)=>{this.queue.push({resolve:e,reject:t,timestamp:Date.now()}),this.processQueue()})}async execute(e){return await this.acquire(),e()}getStatus(){return this.refillTokens(),{tokens:this.tokens,queueLength:this.queue.length,maxRequests:this.config.maxRequests,intervalMs:this.config.intervalMs}}clearQueue(){for(const e of this.queue)e.reject(new Error("Rate limiter queue cleared"));this.queue=[]}reset(){this.tokens=this.config.maxRequests,this.lastRefill=Date.now(),this.clearQueue()}}class ke{constructor(){this.limiters=new Map}register(e,t){this.limiters.set(e,new Pe(t))}get(e){return this.limiters.get(e)}async acquire(e){const t=this.limiters.get(e);if(!t)throw new Error(`No rate limiter registered for source: ${e}`);return t.acquire()}async execute(e,t){const i=this.limiters.get(e);if(!i)throw new Error(`No rate limiter registered for source: ${e}`);return i.execute(t)}getAllStatus(){const e=new Map;for(const[t,i]of this.limiters)e.set(t,i.getStatus());return e}resetAll(){for(const e of this.limiters.values())e.reset()}}class He{constructor(e={}){this.cache=new Map,this.accessOrder=[],this.persistTimer=null,this.maxSize=e.maxSize||100,this.defaultTTL=e.defaultTTL||36e5,this.persistent=e.persistent||!1,this.cacheDir=e.cacheDir||a(o(),".tle-parser","cache"),this.cacheFile=e.cacheFile||"tle-cache.json",this.persistent&&(this.loadFromDisk().catch(()=>{}),this.persistTimer=setInterval(()=>{this.saveToDisk().catch(()=>{})},3e5))}get(e){const t=this.cache.get(e);if(t){if(!(Date.now()-t.timestamp>t.ttl))return this.updateAccessOrder(e),t.value;this.delete(e)}}set(e,t,i){const s={value:t,timestamp:Date.now(),ttl:i||this.defaultTTL};if(this.cache.size>=this.maxSize&&!this.cache.has(e)){const e=this.accessOrder[0];e&&this.delete(e)}this.cache.set(e,s),this.updateAccessOrder(e)}has(e){return void 0!==this.get(e)}delete(e){return this.accessOrder=this.accessOrder.filter(t=>t!==e),this.cache.delete(e)}clear(){this.cache.clear(),this.accessOrder=[]}size(){return this.cleanExpired(),this.cache.size}cleanExpired(){const e=Date.now();let t=0;for(const[i,s]of this.cache.entries())e-s.timestamp>s.ttl&&(this.delete(i),t++);return t}keys(){return this.cleanExpired(),Array.from(this.cache.keys())}getStats(){const e=this.size(),t=this.accessOrder[0]||null,i=this.accessOrder[this.accessOrder.length-1]||null;return{size:e,maxSize:this.maxSize,hitRate:0,oldestEntry:t,newestEntry:i}}updateAccessOrder(e){this.accessOrder=this.accessOrder.filter(t=>t!==e),this.accessOrder.push(e)}async saveToDisk(){if(this.persistent)try{r(this.cacheDir)||await e(this.cacheDir,{recursive:!0});const i={entries:Array.from(this.cache.entries()),accessOrder:this.accessOrder,timestamp:Date.now()},s=a(this.cacheDir,this.cacheFile);await t(s,JSON.stringify(i,null,2),"utf8")}catch(e){console.error("Failed to save cache to disk:",e)}}async loadFromDisk(){if(this.persistent)try{const e=a(this.cacheDir,this.cacheFile);if(!r(e))return;const t=await i(e,"utf8"),s=JSON.parse(t);this.cache.clear();for(const[e,t]of s.entries)this.cache.set(e,t);this.accessOrder=s.accessOrder||[],this.cleanExpired()}catch(e){console.error("Failed to load cache from disk:",e)}}destroy(){this.persistTimer&&(clearInterval(this.persistTimer),this.persistTimer=null),this.persistent&&this.saveToDisk().catch(()=>{}),this.clear()}}const We=new He({maxSize:1e3,defaultTTL:36e5,persistent:!0,cacheFile:"tle-data.json"});function Ye(e,t={}){const i=Object.keys(t).sort().map(e=>`${e}=${t[e]}`).join("&");return i?`${e}:${i}`:e}class Be{constructor(e={}){this.baseUrl="https://celestrak.org/NORAD/elements/gp.php",this.config={type:"celestrak",baseUrl:e.baseUrl||this.baseUrl,enableCache:!1!==e.enableCache,cacheTTL:e.cacheTTL||36e5,timeout:e.timeout||3e4,rateLimit:e.rateLimit||{maxRequests:20,intervalMs:6e4},...e},this.rateLimiter=new Pe(this.config.rateLimit),this.cache=new He({maxSize:100,defaultTTL:this.config.cacheTTL,persistent:!0,cacheFile:"celestrak-cache.json"})}async fetch(e={}){const t=this.generateCacheKey(e),i=Date.now();if(this.config.enableCache&&!e.forceRefresh){const s=this.cache.get(t);if(s){const t=w(s,e.parseOptions||{});return{data:t,source:"celestrak",timestamp:new Date,cached:!0,count:t.length,age:Date.now()-i}}}const s=this.buildUrl(e),n=await this.rateLimiter.execute(async()=>{const e=new AbortController,t=setTimeout(()=>e.abort(),this.config.timeout);try{const t=await fetch(s,{headers:this.config.headers,signal:e.signal});if(!t.ok)throw new Error(`CelesTrak fetch failed: ${t.status} ${t.statusText}`);return await t.text()}finally{clearTimeout(t)}});this.config.enableCache&&this.cache.set(t,n,this.config.cacheTTL);const r=w(n,e.parseOptions||{});return{data:r,source:"celestrak",timestamp:new Date,cached:!1,count:r.length,age:Date.now()-i}}buildUrl(e){const t=new URLSearchParams;if(e.catalogNumber){const i=Array.isArray(e.catalogNumber)?e.catalogNumber:[e.catalogNumber];t.append("CATNR",i.join(",")),t.append("FORMAT","TLE")}else e.group?(t.append("GROUP",e.group),t.append("FORMAT","TLE")):e.namePattern?(t.append("NAME",e.namePattern),t.append("FORMAT","TLE")):e.intlDesignator?(t.append("INTDES",e.intlDesignator),t.append("FORMAT","TLE")):(t.append("GROUP","active"),t.append("FORMAT","TLE"));if(e.queryParams)for(const[i,s]of Object.entries(e.queryParams))t.append(i,s);return`${this.config.baseUrl}?${t.toString()}`}generateCacheKey(e){return Ye("celestrak",{catalog:e.catalogNumber,group:e.group,name:e.namePattern,intl:e.intlDesignator})}clearCache(){this.cache.clear()}getCacheStats(){return this.cache.getStats()}}class je{constructor(e={}){if(this.baseUrl="https://www.space-track.org",this.authUrl="https://www.space-track.org/ajaxauth/login",this.queryUrl="https://www.space-track.org/basicspacedata/query",this.sessionCookie=null,this.lastAuth=0,this.authTTL=72e5,!e.credentials?.username||!e.credentials?.password)throw new Error("Space-Track.org requires username and password credentials");this.config={type:"spacetrack",baseUrl:e.baseUrl||this.baseUrl,credentials:e.credentials,enableCache:!1!==e.enableCache,cacheTTL:e.cacheTTL||18e5,timeout:e.timeout||6e4,rateLimit:e.rateLimit||{maxRequests:20,intervalMs:6e4},...e},this.rateLimiter=new Pe(this.config.rateLimit),this.cache=new He({maxSize:100,defaultTTL:this.config.cacheTTL,persistent:!0,cacheFile:"spacetrack-cache.json"})}async authenticate(){if(this.sessionCookie&&Date.now()-this.lastAuth<this.authTTL)return;const e=new URLSearchParams;e.append("identity",this.config.credentials.username),e.append("password",this.config.credentials.password);const t=await fetch(this.authUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString()});if(!t.ok)throw new Error(`Space-Track authentication failed: ${t.status} ${t.statusText}`);const i=t.headers.get("set-cookie");if(i){const e=i.match(/chocolatechip=([^;]+)/);e&&e[1]&&(this.sessionCookie=e[1],this.lastAuth=Date.now())}if(!this.sessionCookie)throw new Error("Failed to obtain Space-Track session cookie")}async fetch(e={}){const t=this.generateCacheKey(e),i=Date.now();if(this.config.enableCache&&!e.forceRefresh){const s=this.cache.get(t);if(s){const t=w(s,e.parseOptions||{});return{data:t,source:"spacetrack",timestamp:new Date,cached:!0,count:t.length,age:Date.now()-i}}}await this.authenticate();const s=this.buildUrl(e),n=await this.rateLimiter.execute(async()=>{const e=new AbortController,t=setTimeout(()=>e.abort(),this.config.timeout);try{const t=await fetch(s,{headers:{Cookie:`chocolatechip=${this.sessionCookie}`,...this.config.headers},signal:e.signal});if(!t.ok){if(401===t.status){this.sessionCookie=null,await this.authenticate();const t=await fetch(s,{headers:{Cookie:`chocolatechip=${this.sessionCookie}`,...this.config.headers},signal:e.signal});if(!t.ok)throw new Error(`Space-Track fetch failed: ${t.status} ${t.statusText}`);return await t.text()}throw new Error(`Space-Track fetch failed: ${t.status} ${t.statusText}`)}const i=await t.text();try{const e=JSON.parse(i);return this.jsonToTLE(e)}catch{return i}}finally{clearTimeout(t)}});this.config.enableCache&&this.cache.set(t,n,this.config.cacheTTL);const r=w(n,e.parseOptions||{});return{data:r,source:"spacetrack",timestamp:new Date,cached:!1,count:r.length,age:Date.now()-i}}buildUrl(e){let t="/class/gp/";return e.catalogNumber&&(t+=`NORAD_CAT_ID/${(Array.isArray(e.catalogNumber)?e.catalogNumber:[e.catalogNumber]).join(",")}/`),e.intlDesignator&&(t+=`INTLDES/${e.intlDesignator}/`),t+="orderby/EPOCH%20desc/limit/1000/format/tle",`${this.queryUrl}${t}`}jsonToTLE(e){return Array.isArray(e)?e.map(e=>{const t=[];return e.OBJECT_NAME&&t.push(e.OBJECT_NAME),e.TLE_LINE1&&t.push(e.TLE_LINE1),e.TLE_LINE2&&t.push(e.TLE_LINE2),t.join("\n")}).join("\n"):""}generateCacheKey(e){return Ye("spacetrack",{catalog:e.catalogNumber,intl:e.intlDesignator})}clearCache(){this.cache.clear()}getCacheStats(){return this.cache.getStats()}logout(){this.sessionCookie=null,this.lastAuth=0}}class Ke{constructor(e={}){this.baseUrl="https://www.amsat.org/tle/current/nasabare.txt",this.config={type:"amsat",baseUrl:e.baseUrl||this.baseUrl,enableCache:!1!==e.enableCache,cacheTTL:e.cacheTTL||36e5,timeout:e.timeout||3e4,rateLimit:e.rateLimit||{maxRequests:10,intervalMs:6e4},...e},this.rateLimiter=new Pe(this.config.rateLimit),this.cache=new He({maxSize:10,defaultTTL:this.config.cacheTTL,persistent:!0,cacheFile:"amsat-cache.json"})}async fetch(e={}){const t="amsat:all",i=Date.now();if(this.config.enableCache&&!e.forceRefresh){const s=this.cache.get(t);if(s){const t=w(s,e.parseOptions||{});return{data:t,source:"amsat",timestamp:new Date,cached:!0,count:t.length,age:Date.now()-i}}}const s=await this.rateLimiter.execute(async()=>{const e=new AbortController,t=setTimeout(()=>e.abort(),this.config.timeout);try{const t=await fetch(this.config.baseUrl,{headers:this.config.headers,signal:e.signal});if(!t.ok)throw new Error(`AMSAT fetch failed: ${t.status} ${t.statusText}`);return await t.text()}finally{clearTimeout(t)}});this.config.enableCache&&this.cache.set(t,s,this.config.cacheTTL);const n=w(s,e.parseOptions||{});return{data:n,source:"amsat",timestamp:new Date,cached:!1,count:n.length,age:Date.now()-i}}clearCache(){this.cache.clear()}getCacheStats(){return this.cache.getStats()}}class qe{constructor(e){if(!e.baseUrl)throw new Error("Custom source requires a base URL");this.config={...e,type:"custom",enableCache:!1!==e.enableCache,cacheTTL:e.cacheTTL||36e5,timeout:e.timeout||3e4,rateLimit:e.rateLimit||{maxRequests:10,intervalMs:6e4}},this.rateLimiter=new Pe(this.config.rateLimit),this.cache=new He({maxSize:50,defaultTTL:this.config.cacheTTL,persistent:!0,cacheFile:"custom-cache.json"})}async fetch(e={}){const t=e.queryParams?.url||this.config.baseUrl,i=Ye("custom",{url:t}),s=Date.now();if(this.config.enableCache&&!e.forceRefresh){const t=this.cache.get(i);if(t){const i=w(t,e.parseOptions||{});return{data:i,source:"custom",timestamp:new Date,cached:!0,count:i.length,age:Date.now()-s}}}const n=await this.rateLimiter.execute(async()=>{const e=new AbortController,i=setTimeout(()=>e.abort(),this.config.timeout);try{const i={...this.config.headers};this.config.credentials?.apiKey&&(i.Authorization=`Bearer ${this.config.credentials.apiKey}`);const s=await fetch(t,{headers:i,signal:e.signal});if(!s.ok)throw new Error(`Custom source fetch failed: ${s.status} ${s.statusText}`);return await s.text()}finally{clearTimeout(i)}});this.config.enableCache&&this.cache.set(i,n,this.config.cacheTTL);const r=w(n,e.parseOptions||{});return{data:r,source:"custom",timestamp:new Date,cached:!1,count:r.length,age:Date.now()-s}}clearCache(){this.cache.clear()}getCacheStats(){return this.cache.getStats()}}class ze{constructor(){this.sources=new Map,this.primarySource=null,this.failoverOrder=[]}register(e,t,i={}){this.sources.set(e,t),i.primary&&(this.primarySource=e),!1!==i.failover&&this.failoverOrder.push(e)}async fetch(e,t={}){const i=e||this.primarySource;if(!i)throw new Error("No data source specified and no primary source configured");const s=[i,...this.failoverOrder.filter(e=>e!==i)];let n=null;for(const e of s){const i=this.sources.get(e);if(i)try{return await i.fetch(t)}catch(t){n=t,console.error(`Failed to fetch from ${e}:`,t)}}throw new Error(`All data sources failed. Last error: ${n?.message||"Unknown error"}`)}getSource(e){return this.sources.get(e)}listSources(){return Array.from(this.sources.keys())}clearAllCaches(){for(const e of this.sources.values())e.clearCache()}}function Xe(e,t=2592e5){const i=parseInt(e.epochYear,10),s=parseFloat(e.epoch),n=new Date(i<57?2e3+i:1900+i,0,1);n.setDate(s);const r=Date.now()-n.getTime(),a=r<=t,o=Math.floor(r/864e5);return{isFresh:a,age:r,epochDate:n,message:a?`TLE is fresh (${o} days old)`:`TLE is stale (${o} days old)`}}function Ze(e,t=2592e5){return e.filter(e=>Xe(e,t).isFresh)}const Je={starlink:{name:"Starlink",description:"SpaceX Starlink satellite constellation",namePatterns:[/^STARLINK-/i,/^STARLINK /i],intlDesignatorPatterns:[/^\d{2}-(0[0-9]{2}|1[0-9]{2})[A-Z]{1,3}$/]},oneweb:{name:"OneWeb",description:"OneWeb satellite constellation",namePatterns:[/^ONEWEB-/i,/^ONEWEB /i]},gps:{name:"GPS",description:"Global Positioning System satellites",namePatterns:[/^GPS /i,/^NAVSTAR/i,/^USA-/i],catalogNumbers:[[20959,20959],[22014,22014],[22877,22877],[23833,23833],[24876,24876],[25933,25933],[26360,26360],[26407,26407],[26605,26605],[26690,26690],[28361,28361],[28474,28474],[28874,28874],[29486,29486],[29601,29601],[32260,32260],[32384,32384],[32711,32711],[35752,35752],[36585,36585],[37753,37753],[38833,38833],[39166,39166],[40105,40105],[40294,40294],[40534,40534],[40730,40730],[41019,41019],[41328,41328],[36500,36600],[4e4,41400]]},galileo:{name:"Galileo",description:"European GNSS constellation",namePatterns:[/^GALILEO/i,/^GSAT/i],catalogNumbers:[[37846,37846],[37847,37847],[38857,38857],[38858,38858],[40128,40128],[40129,40129],[40544,40544],[40545,40545],[40889,40889],[40890,40890],[41174,41174],[41175,41175],[41549,41549],[41550,41550],[41859,41859],[41860,41860],[41861,41861],[41862,41862],[43055,43055],[43056,43056],[43057,43057],[43058,43058],[43564,43564],[43565,43565],[43566,43566],[43567,43567]]},glonass:{name:"GLONASS",description:"Russian GNSS constellation",namePatterns:[/^COSMOS \d+$/i,/^GLONASS/i],catalogNumbers:[[28915,28915],[32275,32275],[32276,32276],[32393,32393],[32395,32395],[36111,36111],[36112,36112],[36113,36113],[36400,36400],[36401,36401],[36402,36402],[37139,37139],[37140,37140],[37141,37141],[37829,37829],[37869,37869],[37870,37870],[39155,39155],[39620,39620],[39621,39621],[39622,39622],[40001,40001],[40315,40315],[40315,40315],[41330,41330],[41554,41554],[41555,41555],[36400,36410],[37800,37900],[39100,39700],[4e4,41600]]},beidou:{name:"BeiDou",description:"Chinese GNSS constellation",namePatterns:[/^BEIDOU/i,/^BDS/i,/^COMPASS/i],catalogNumbers:[[36287,36287],[36828,36828],[37210,37210],[37384,37384],[37763,37763],[37948,37948],[38091,38091],[38250,38250],[38251,38251],[38775,38775],[40549,40549],[40748,40748],[40749,40749],[40938,40938],[41434,41434],[41586,41586],[43001,43001],[43002,43002],[43107,43107],[43108,43108],[43207,43207],[43208,43208],[43245,43245],[43246,43246],[36200,43300]]},iss:{name:"ISS",description:"International Space Station",catalogNumbers:[25544],namePatterns:[/^ISS/i]},amateur:{name:"Amateur Radio",description:"Amateur radio satellites",namePatterns:[/^AO-/i,/^SO-/i,/^FO-/i,/^FUNCUBE/i,/^LILACSAT/i,/^DIWATA/i,/^OSCAR/i,/^AMSAT/i,/^CUBESAT/i,/^RS-/i,/^ZARYA/i]},weather:{name:"Weather",description:"Weather and meteorological satellites",namePatterns:[/^NOAA /i,/^GOES /i,/^METEOSAT/i,/^METEOR/i,/^FENGYUN/i,/^FY-/i,/^HIMAWARI/i]},iridium:{name:"Iridium",description:"Iridium satellite constellation",namePatterns:[/^IRIDIUM/i],catalogNumbers:[[41917,41927],[41934,41944],[42803,42813],[42955,42965],[43070,43080],[43249,43259],[43478,43488],[43569,43579]]},planet:{name:"Planet Labs",description:"Planet Labs Earth imaging satellites",namePatterns:[/^DOVE/i,/^FLOCK/i,/^PLANET/i,/^SKYSAT/i]},spire:{name:"Spire",description:"Spire Global satellite constellation",namePatterns:[/^LEMUR/i,/^SPIRE/i]}};function Qe(e){return Je[e.toLowerCase()]}function et(){return Object.keys(Je)}function tt(e){const t=Qe(e);if(!t)return;const i={};if(t.catalogNumbers&&t.catalogNumbers.length>0&&(i.satelliteNumber=e=>{const i=parseInt(e,10);return!isNaN(i)&&t.catalogNumbers.some(e=>Array.isArray(e)?i>=e[0]&&i<=e[1]:i===e)}),t.namePatterns&&t.namePatterns.length>0){const e=i.satelliteName;i.satelliteName=i=>{const s=t.namePatterns.some(e=>e.test(i));return e&&"function"==typeof e?s&&e(i):s}}if(t.customFilter){const e=i.custom;i.custom=i=>{const s=t.customFilter(i);return e?s&&e(i):s}}return i}function it(e,t){const i=Qe(t);if(!i)return!1;if(i.catalogNumbers&&i.catalogNumbers.length>0){const t=parseInt(e.satelliteNumber1,10);if(!isNaN(t)&&i.catalogNumbers.some(e=>Array.isArray(e)?t>=e[0]&&t<=e[1]:t===e))return!0}return!!(i.namePatterns&&e.satelliteName&&i.namePatterns.some(t=>t.test(e.satelliteName)))||!!i.customFilter&&i.customFilter(e)}function st(e,t){return e.filter(e=>it(e,t))}function nt(e){const t=new Map;for(const i of e){let e=!1;for(const[s]of Object.entries(Je))if(it(i,s)){t.has(s)||t.set(s,[]),t.get(s).push(i),e=!0;break}e||(t.has("unknown")||t.set("unknown",[]),t.get("unknown").push(i))}return t}class rt{constructor(e,t){this.manager=e,this.config=t,this.timer=null,this.isRunning=!1,this.lastUpdate=null,this.updateCount=0,this.errorCount=0,this.lastError=null,this.retryCount=0,t.autoStart&&this.start()}start(){this.isRunning||(this.isRunning=!0,this.scheduleNext())}stop(){this.timer&&(clearTimeout(this.timer),this.timer=null),this.isRunning=!1}scheduleNext(){this.isRunning&&(this.timer=setTimeout(()=>{this.executeUpdate()},this.config.intervalMs))}async executeUpdate(){try{const e=await this.manager.fetch(this.config.source||null,this.config.fetchOptions||{});this.lastUpdate=new Date,this.updateCount++,this.retryCount=0,this.lastError=null,this.config.onUpdate&&this.config.onUpdate(e),this.scheduleNext()}catch(e){this.errorCount++,this.lastError=e,this.config.onError&&this.config.onError(this.lastError);const t=this.config.maxRetries||3;if(this.retryCount<t){this.retryCount++;const e=this.config.retryDelayMs||6e4;this.timer=setTimeout(()=>{this.executeUpdate()},e)}else this.retryCount=0,this.scheduleNext()}}async updateNow(){return this.manager.fetch(this.config.source||null,this.config.fetchOptions||{})}getStatus(){return{isRunning:this.isRunning,lastUpdate:this.lastUpdate,nextUpdate:this.timer?new Date(Date.now()+this.config.intervalMs):null,updateCount:this.updateCount,errorCount:this.errorCount,lastError:this.lastError}}updateConfig(e){Object.assign(this.config,e),this.isRunning&&(this.stop(),this.start())}resetStats(){this.updateCount=0,this.errorCount=0,this.lastError=null,this.retryCount=0}}class at{constructor(){this.schedulers=new Map}create(e,t,i){const s=new rt(t,i);return this.schedulers.set(e,s),s}get(e){return this.schedulers.get(e)}remove(e){const t=this.schedulers.get(e);return!!t&&(t.stop(),this.schedulers.delete(e))}startAll(){for(const e of this.schedulers.values())e.start()}stopAll(){for(const e of this.schedulers.values())e.stop()}getAllStatus(){const e=new Map;for(const[t,i]of this.schedulers)e.set(t,i.getStatus());return e}list(){return Array.from(this.schedulers.keys())}}const ot={EVERY_15_MINUTES:9e5,EVERY_30_MINUTES:18e5,HOURLY:36e5,EVERY_2_HOURS:72e5,EVERY_6_HOURS:216e5,EVERY_12_HOURS:432e5,DAILY:864e5,WEEKLY:6048e5};function ct(e){const t=e.match(/^(\d+)\s*(ms|s|m|h|d|w)$/i);if(!t||!t[1]||!t[2])throw new Error(`Invalid interval format: ${e}`);const i=parseInt(t[1],10),s=t[2].toLowerCase();switch(s){case"ms":return i;case"s":return 1e3*i;case"m":return 60*i*1e3;case"h":return 60*i*60*1e3;case"d":return 24*i*60*60*1e3;case"w":return 7*i*24*60*60*1e3;default:throw new Error(`Unknown interval unit: ${s}`)}}const lt={lineNumber1:[0,1],satelliteNumber1:[2,7],classification:[7,8],internationalDesignatorYear:[9,11],internationalDesignatorLaunchNumber:[11,14],internationalDesignatorPiece:[14,17],epochYear:[18,20],epoch:[20,32],firstDerivative:[33,43],secondDerivative:[44,52],bStar:[53,61],ephemerisType:[62,63],elementSetNumber:[64,68],checksum1:[68,69],lineNumber2:[0,1],satelliteNumber2:[2,7],inclination:[8,16],rightAscension:[17,25],eccentricity:[26,33],argumentOfPerigee:[34,42],meanAnomaly:[43,51],meanMotion:[52,63],revolutionNumber:[63,68],checksum2:[68,69]};class ut extends Error{constructor(e,t,i=[]){super(e),this.name="TLEValidationError",this.errors=t,this.warnings=i,"function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}}class ht extends Error{constructor(e,t,i={}){super(e),this.name="TLEFormatError",this.code=t,this.details=i,"function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}}function mt(e){return e.replace(/\r\n/g,"\n").replace(/\r/g,"\n")}function dt(e){return mt(e).split("\n").map(e=>e.replace(/\t/g," ").trim()).filter(e=>e.length>0)}function pt(e){let t=0;for(let i=0;i<e.length-1;i++){const s=e[i];s&&s>="0"&&s<="9"?t+=parseInt(s,10):"-"===s&&(t+=1)}return t%10}function gt(e){if(69!==e.length)return{isValid:!1,expected:null,actual:null,error:{code:h.INVALID_LINE_LENGTH,message:"Line length must be 69 characters",field:"line_length",expected:69,actual:e.length,severity:"error"}};const t=pt(e),i=parseInt(e[68]||"",10);if(isNaN(i))return{isValid:!1,expected:t,actual:null,error:{code:h.INVALID_CHECKSUM_CHARACTER,message:"Checksum position must contain a digit",field:"checksum",position:68,value:e[68],severity:"error"}};const s=t===i;return{isValid:s,expected:t,actual:i,error:s?null:{code:h.CHECKSUM_MISMATCH,message:`Checksum mismatch: expected ${t}, got ${i}`,field:"checksum",expected:t,actual:i,severity:"error"}}}function Nt(e,t){const i=[];if(69!==e.length)return i.push({code:h.INVALID_LINE_LENGTH,message:`Line ${t} must be exactly 69 characters (got ${e.length})`,line:t,field:"line_length",expected:69,actual:e.length,severity:"error"}),{isValid:!1,errors:i};const s=e[0];s!==t.toString()&&i.push({code:h.INVALID_LINE_NUMBER,message:`Line ${t} must start with '${t}' (got '${s}')`,line:t,field:"line_number",expected:t.toString(),actual:s,severity:"error"});const n=gt(e);return!n.isValid&&n.error&&i.push({...n.error,line:t,message:`Line ${t}: ${n.error.message}`}),{isValid:0===i.length,errors:i}}function ft(e,t){const i=e.substring(2,7).trim(),s=t.substring(2,7).trim();return i!==s?{isValid:!1,error:{code:h.SATELLITE_NUMBER_MISMATCH,message:`Satellite numbers must match (Line 1: ${i}, Line 2: ${s})`,field:"satellite_number",line1Value:i,line2Value:s,severity:"error"}}:/^\d+$/.test(i)?{isValid:!0,error:null}:{isValid:!1,error:{code:h.INVALID_SATELLITE_NUMBER,message:`Satellite number must be numeric (got '${i}')`,field:"satellite_number",value:i,severity:"error"}}}function Et(e){const t=e[7],i=["U","C","S"];return i.includes(t||"")?{isValid:!0,error:null}:{isValid:!1,error:{code:h.INVALID_CLASSIFICATION,message:`Classification must be U, C, or S (got '${t}')`,field:"classification",expected:i,actual:t,severity:"error"}}}function It(e,t,i,s){const n=parseFloat(e);return isNaN(n)?{isValid:!1,error:{code:h.INVALID_NUMBER_FORMAT,message:`${t} must be numeric (got '${e}')`,field:t,value:e,severity:"error"}}:n<i||n>s?{isValid:!1,error:{code:h.VALUE_OUT_OF_RANGE,message:`${t} must be between ${i} and ${s} (got ${n})`,field:t,value:n,min:i,max:s,severity:"error"}}:{isValid:!0,error:null}}function At(e){const t=[],i=e[7];return"C"!==i&&"S"!==i||t.push({code:h.CLASSIFIED_DATA_WARNING,message:`Classification '${i}' is unusual in public TLE data (typically 'U' for unclassified)`,field:"classification",value:i,severity:"warning"}),t}function Tt(e){const t=[],i=parseInt(e.substring(18,20),10),s=parseFloat(e.substring(20,32));if(isNaN(i)||isNaN(s))return t;const n=i>=57?1900+i:2e3+i;n<2e3&&t.push({code:h.DEPRECATED_EPOCH_YEAR_WARNING,message:`Epoch year ${n} is in the deprecated 1900s range (two-digit year: ${i})`,field:"epochYear",value:i,fullYear:n,severity:"warning"});const r=new Date(n,0,1);r.setDate(r.getDate()+s-1);const a=((new Date).getTime()-r.getTime())/864e5;return a>30&&t.push({code:h.STALE_TLE_WARNING,message:`TLE epoch is ${Math.floor(a)} days old (epoch: ${r.toISOString().split("T")[0]}). TLE data may be stale.`,field:"epoch",daysSinceEpoch:Math.floor(a),epochDate:r.toISOString().split("T")[0],severity:"warning"}),t}function Rt(e){const t=[],i=parseFloat("0."+e.substring(26,33).trim());!isNaN(i)&&i>.25&&t.push({code:h.HIGH_ECCENTRICITY_WARNING,message:`Eccentricity ${i.toFixed(7)} is unusually high. This indicates a highly elliptical orbit.`,field:"eccentricity",value:i,severity:"warning"});const s=parseFloat(e.substring(52,63).trim());!isNaN(s)&&s<1&&t.push({code:h.LOW_MEAN_MOTION_WARNING,message:`Mean motion ${s.toFixed(8)} rev/day is unusually low. This indicates a very high orbit.`,field:"meanMotion",value:s,severity:"warning"});const n=parseInt(e.substring(63,68).trim(),10);return!isNaN(n)&&n>9e4&&t.push({code:h.REVOLUTION_NUMBER_ROLLOVER_WARNING,message:`Revolution number ${n} is approaching rollover limit (99999). Counter may reset soon.`,field:"revolutionNumber",value:n,severity:"warning"}),t}function Lt(e){const t=[],i=e.substring(53,61).trim();"00000-0"!==i&&"00000+0"!==i&&"00000 0"!==i||t.push({code:h.NEAR_ZERO_DRAG_WARNING,message:"B* drag term is zero or near-zero, which is unusual for most satellites in LEO",field:"bStar",value:i,severity:"warning"});const s=parseFloat(e.substring(33,43).trim());!isNaN(s)&&s<0&&t.push({code:h.NEGATIVE_DECAY_WARNING,message:`First derivative of mean motion is negative (${s}), indicating orbital decay`,field:"firstDerivative",value:s,severity:"warning"});const n=e.substring(62,63).trim();return"0"!==n&&""!==n&&t.push({code:h.NON_STANDARD_EPHEMERIS_WARNING,message:`Ephemeris type '${n}' is non-standard (expected '0' for SGP4/SDP4)`,field:"ephemerisType",value:n,severity:"warning"}),t}function _t(e,t={}){if("string"!=typeof e)throw new TypeError("TLE data must be a string");if("object"!=typeof t||null===t||Array.isArray(t))throw new TypeError("Options must be an object");if(0===e.length)throw new ht("TLE string cannot be empty",h.EMPTY_INPUT,{inputLength:0});const{strictChecksums:i=!0,validateRanges:s=!0,mode:n="strict"}=t;if("strict"!==n&&"permissive"!==n)throw new TypeError('Mode must be either "strict" or "permissive"');const r=[],a=[],o=mt(e).trim().split("\n").map(e=>e.trim()).filter(e=>e.length>0&&!e.startsWith("#"));if(o.length<2)return r.push({code:h.INVALID_LINE_COUNT,message:"TLE must contain at least 2 lines",field:"line_count",expected:"2 or 3",actual:o.length,severity:"error"}),{isValid:!1,errors:r,warnings:a};if(o.length>3)return r.push({code:h.INVALID_LINE_COUNT,message:`TLE must contain 2 or 3 lines (got ${o.length})`,field:"line_count",expected:"2 or 3",actual:o.length,severity:"error"}),{isValid:!1,errors:r,warnings:a};let c=0,l=1;if(3===o.length){c=1,l=2;const e=o[0];!e||"1"!==e[0]&&"2"!==e[0]||a.push({code:h.SATELLITE_NAME_FORMAT_WARNING,message:'Line 0 starts with "1" or "2", might be incorrectly formatted',field:"satellite_name",value:e,severity:"warning"}),e&&e.length>24&&a.push({code:h.SATELLITE_NAME_TOO_LONG,message:"Satellite name (Line 0) should be 24 characters or less",field:"satellite_name",expected:24,actual:e.length,severity:"warning"})}const u=o[c],m=o[l];if(!u||!m)return r.push({code:h.INVALID_LINE_COUNT,message:"Missing required TLE lines",severity:"error"}),{isValid:!1,errors:r,warnings:a};const d=Nt(u,1);if(!d.isValid)if("permissive"===n){const e=d.errors.filter(e=>e.code!==h.CHECKSUM_MISMATCH&&e.code!==h.INVALID_CHECKSUM_CHARACTER),t=d.errors.filter(e=>e.code===h.CHECKSUM_MISMATCH||e.code===h.INVALID_CHECKSUM_CHARACTER);if(r.push(...e),a.push(...t.map(e=>({...e,severity:"warning"}))),e.length>0)return{isValid:!1,errors:r,warnings:a}}else if(r.push(...d.errors),i)return{isValid:!1,errors:r,warnings:a};const p=Nt(m,2);if(!p.isValid)if("permissive"===n){const e=p.errors.filter(e=>e.code!==h.CHECKSUM_MISMATCH&&e.code!==h.INVALID_CHECKSUM_CHARACTER),t=p.errors.filter(e=>e.code===h.CHECKSUM_MISMATCH||e.code===h.INVALID_CHECKSUM_CHARACTER);if(r.push(...e),a.push(...t.map(e=>({...e,severity:"warning"}))),e.length>0)return{isValid:!1,errors:r,warnings:a}}else if(r.push(...p.errors),i)return{isValid:!1,errors:r,warnings:a};const g=ft(u,m);!g.isValid&&g.error&&("permissive"===n?a.push({...g.error,severity:"warning"}):r.push(g.error));const N=Et(u);if(!N.isValid&&N.error&&("permissive"===n?a.push({...N.error,severity:"warning"}):r.push(N.error)),s&&69===u.length&&69===m.length){const e=[{value:u.substring(2,7).trim(),name:"Satellite Number",min:1,max:99999},{value:u.substring(9,11).trim(),name:"International Designator Year",min:0,max:99,optional:!0},{value:u.substring(11,14).trim(),name:"International Designator Launch Number",min:1,max:999,optional:!0},{value:u.substring(62,63).trim(),name:"Ephemeris Type",min:0,max:9,optional:!0},{value:u.substring(64,68).trim(),name:"Element Set Number",min:0,max:9999,optional:!0},{value:u.substring(18,20).trim(),name:"Epoch Year",min:0,max:99},{value:u.substring(20,32).trim(),name:"Epoch Day",min:1,max:366.99999999},{value:m.substring(8,16).trim(),name:"Inclination",min:0,max:180},{value:m.substring(17,25).trim(),name:"Right Ascension",min:0,max:360},{value:"0."+m.substring(26,33).trim(),name:"Eccentricity",min:0,max:1},{value:m.substring(34,42).trim(),name:"Argument of Perigee",min:0,max:360},{value:m.substring(43,51).trim(),name:"Mean Anomaly",min:0,max:360},{value:m.substring(52,63).trim(),name:"Mean Motion",min:0,max:20,warningOnly:!0},{value:m.substring(63,68).trim(),name:"Revolution Number",min:0,max:99999,optional:!0}];for(const{value:t,name:i,min:s,max:o,optional:c,warningOnly:l}of e){if(c&&0===t.length)continue;const e=It(t,i,s,o);!e.isValid&&e.error&&(l||"permissive"===n?a.push({...e.error,severity:"warning"}):r.push(e.error))}}return 69===u.length&&(a.push(...At(u)),a.push(...Tt(u)),a.push(...Lt(u))),69===m.length&&a.push(...Rt(m)),{isValid:0===r.length,errors:r,warnings:a}}function yt(e,t={}){if("string"!=typeof e)throw new TypeError("TLE data must be a string");if("object"!=typeof t||null===t||Array.isArray(t))throw new TypeError("Options must be an object");const{validate:i=!0,strictChecksums:s=!0,validateRanges:n=!0,includeWarnings:r=!0,includeComments:a=!0,mode:o="strict"}=t;let c=[];if(i){const t=_t(e,{strictChecksums:s,validateRanges:n,mode:o});if(!t.isValid){const e="TLE validation failed:\n"+t.errors.map(e=>"string"==typeof e?e:e.message).join("\n");throw new ut(e,t.errors,t.warnings)}c=t.warnings}const l=mt(e).trim().split("\n").map(e=>e.trim()).filter(e=>e.length>0),u=l.filter(e=>e.startsWith("#")),m=l.filter(e=>!e.startsWith("#"));let d=0,p=1,g=null;3===m.length&&(g=m[0]||null,d=1,p=2);const N=m[d],f=m[p];if(!N||!f)throw new ht("Missing required TLE lines",h.INVALID_LINE_COUNT);const E={satelliteName:g},I=["lineNumber2","satelliteNumber2","inclination","rightAscension","eccentricity","argumentOfPerigee","meanAnomaly","meanMotion","revolutionNumber","checksum2"];for(const[e,t]of Object.entries(lt)){const[i,s]=t,n=I.includes(e)?f:N;E[e]=n.substring(i,s).trim()}return r&&c.length>0&&(E.warnings=c),a&&u.length>0&&(E.comments=u),E}var St={parseTLE:yt,validateTLE:_t,calculateChecksum:pt,validateChecksum:gt,validateLineStructure:Nt,validateSatelliteNumber:ft,validateClassification:Et,validateNumericRange:It,checkClassificationWarnings:At,checkEpochWarnings:Tt,checkOrbitalParameterWarnings:Rt,checkDragAndEphemerisWarnings:Lt,normalizeLineEndings:mt,parseTLELines:dt,TLEValidationError:ut,TLEFormatError:ht,ERROR_CODES:h};export{Ke as AMSATSource,Je as CONSTELLATIONS,Be as CelesTrakSource,be as Colors,qe as CustomSource,_e as DEFAULT_VALIDATION_RULES,re as DESIGNATOR_CONSTRAINTS,ze as DataSourceManager,ne as EPOCH_CONSTRAINTS,h as ERROR_CODES,A as ErrorSeverity,Z as IncrementalParser,B as MiddlewareParser,ie as ORBITAL_PARAMETER_RANGES,I as ParserState,ae as QUALITY_SCORE_WEIGHTS,Pe as RateLimiter,ke as RateLimiterManager,T as RecoveryAction,se as SATELLITE_NUMBER_RANGES,ot as SCHEDULE_INTERVALS,at as SchedulerManager,je as SpaceTrackSource,K as TLECache,N as TLEErrorCode,ht as TLEFormatError,G as TLEParserStream,rt as TLEScheduler,b as TLEStateMachineParser,ut as TLEValidationError,He as TTLCache,Se as ValidationRuleManager,V as applyFilter,pt as calculateChecksum,le as calculateEpochAge,Te as calculateQualityScore,At as checkClassificationWarnings,Lt as checkDragAndEphemerisWarnings,Tt as checkEpochWarnings,Rt as checkOrbitalParameterWarnings,oe as convertEpochToDate,q as createCachedParser,tt as createConstellationFilter,J as createIncrementalParser,j as createMiddlewareParser,P as createTLEParserStream,ye as createValidationRule,St as default,Ae as detectAnomalies,st as filterByConstellation,Ze as filterByFreshness,we as formatAsCSV,Fe as formatAsHuman,Me as formatAsJSON,$e as formatAsXML,Ue as formatAsYAML,Ge as formatTLE,Ye as generateCacheKey,ve as generateValidationReport,Qe as getConstellation,d as getErrorDescription,z as getProfileOptions,ee as getProviderOptions,nt as groupByConstellation,g as isCriticalError,y as isParseFailure,_ as isParseSuccess,D as isParsedTLE,S as isTLEError,v as isTLEWarning,C as isValidClassification,m as isValidErrorCode,L as isValidationFailure,R as isValidationSuccess,p as isWarningCode,et as listConstellations,it as matchesConstellation,pe as normalizeAssumedDecimalNotation,mt as normalizeLineEndings,ge as normalizeScientificNotation,w as parseBatch,U as parseBatchAsync,Y as parseFromCompressed,k as parseFromFile,W as parseFromStream,H as parseFromURL,ct as parseInterval,Q as parseParallel,yt as parseTLE,$ as parseTLEAsync,dt as parseTLELines,X as parseWithProfile,te as parseWithProvider,O as parseWithStateMachine,Ve as reconstructTLE,Le as sanitizeAllFields,Re as sanitizeField,x as splitTLEs,We as tleCache,me as validateAllOrbitalParameters,gt as validateChecksum,Et as validateClassification,ue as validateEpochAge,ce as validateEpochDate,Xe as validateFreshness,fe as validateInternationalDesignator,Nt as validateLineStructure,It as validateNumericRange,he as validateOrbitalParameter,ft as validateSatelliteNumber,_t as validateTLE,F as validateTLEAsync};
//# sourceMappingURL=index.min.mjs.map
